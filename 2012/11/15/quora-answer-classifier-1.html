<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quora Answer Classifier (Part 1, with decision tree learning). &mdash; Mourad Mourafiq</title>
    <!--[if lt IE 9]><script src='https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js'></script><![endif]-->
    
    <link rel="stylesheet" href="/assets/app.css">
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<script src="/assets/app.js"></script>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>

<script>
  var HN=[];HN.factory=function(e){return function(){HN.push([e].concat(Array.prototype.slice.call(arguments,0)))};},HN.on=HN.factory("on"),HN.once=HN.factory("once"),HN.off=HN.factory("off"),HN.emit=HN.factory("emit"),HN.load=function(){var e="hn-button.js";if(document.getElementById(e))return;var t=document.createElement("script");t.id=e,t.src="//hn-button.herokuapp.com/hn-button.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n)},HN.load();</script>
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-34892053-1', 'auto');
  ga('send', 'pageview');
</script>


    <link rel="shortcut icon" href="/favicon.ico?v2" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Mourad Mourafiq" href="/atom.xml" />
    <meta name="title" content="Quora Answer Classifier (Part 1, with decision tree learning). ">
    <link rel="canonical" href="http://mourafiq.com/2012/11/15/quora-answer-classifier-1.html">
     
           
    <meta property="og:title" content="Quora Answer Classifier (Part 1, with decision tree learning)."/>
    <meta property="og:url" content="http://mourafiq.com/2012/11/15/quora-answer-classifier-1.html"/>
    <meta property="og:image" content="http://mourafiq.com/images/posts/quora.png"/>
    
    <meta property="og:description" content="Designing an algorithm to develop classifier that is able to tell good answers from bad answers, as well as humans can."/>
    <meta name="description" content="Designing an algorithm to develop classifier that is able to tell good answers from bad answers, as well as humans can."/>
    
    <meta property="og:site_name" content="Mourad Mourafiq">
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</head>
<body>

    <header class="site-header">
        <nav>
            <a class="brand" href="/">
                <img src="/images/logo.png" alt="Inc">
            </a>
            <a href="/about.html">About</a>
        </nav>
    </header>

    
<div class="cover  article-cover " style="background-image:url(/images/posts/quora.png)"></div>


<div class='cover-caption'><a href='/about.html#pictures'>Quora</a></div>


<article >
    <div class="container">
        <header>
            
            <div class="meta">
                <!--
                By
                <address><a rel="author" href="" title="Mourad Mourafiq." target="_blank">
                    Mourad Mourafiq.
                </a></address> &mdash;
                -->
                <time pubdate datetime="2012-15-November" title="Nov 15, 2012">
                    Nov 15, 2012
                </time> &mdash;
                
26 min read
            </div>
            
            <h1 class="title">Quora Answer Classifier (Part 1, with decision tree learning).</h1>
            <h2 class="subtitle">Designing an algorithm to develop classifier that is able to tell good answers from bad answers, as well as humans can.</h2>
        </header>

        <section>
            <p>Quora uses a combination of machine learning (ML) algorithms and moderation to ensure high-quality content on the site. High answer quality has helped Quora distinguish itself from other Q&amp;A sites on the web.</p>

<p>Your task will be to devise a classifier that is able to tell good answers from bad answers, as well as humans can.  A good answer is denoted by a +1 in our system, and a bad answer is denoted by a -1.</p>

<p><img src="/images/posts/quora-answer-classifier.png" alt="quora-answer-classifier" /></p>

<p><strong>Input format (read from STDIN)</strong>:</p>

<p>The first line contains N, M. N = Number of training data records, M = number of parameters. Followed by N lines containing records of training data. Then one integer q, q = number of records to be classified, followed by q lines of query data</p>

<p>Training data corresponds to the following format:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">&lt;answer-identifier&gt; &lt;+1 or -1&gt; (&lt;feature-index&gt;:&lt;feature-value&gt;)*</span></code></pre></div>

<p>Query data corresponds to the following format:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">&lt;answer-identifier&gt; (&lt;feature-index&gt;:&lt;feature-value&gt;)*</span></code></pre></div>

<p>The answer identifier  is an alphanumeric string of no more than 10 chars.  Each identifier is guaranteed unique.  All feature values are doubles.</p>

<p>0 &lt; M &lt; 100</p>

<p>0 &lt; N &lt; 50,000</p>

<p>0 &lt; q &lt; 5,000</p>

<p>For example:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="lineno">1</span> <span class="go">5 23</span>
<span class="lineno">2</span> <span class="go">2LuzC +1 1:2101216030446 2:1.807711 3:1 4:4.262680 5:4.488636 6:87.000000 7:0.000000 8:0.000000 9:0 10:0 11:3.891820 12:0 13:1 14:0 15:0 16:0 17:1 18:1 19:0 20:2 21:2.197225 22:0.000000 23:0.000000</span>
<span class="lineno">3</span> <span class="go">LmnUc +1 1:99548723068 2:3.032810 3:1 4:2.772589 5:2.708050 6:0.000000 7:0.000000 8:0.000000 9:0 10:0 11:4.727388 12:5 13:1 14:0 15:0 16:1 17:1 18:0 19:0 20:9 21:2.833213 22:0.000000 23:0.000000</span>
<span class="lineno">4</span> <span class="go">ZINTz -1 1:3030695193589 2:1.741764 3:1 4:2.708050 5:4.248495 6:0.000000 7:0.000000 8:0.000000 9:0 10:0 11:3.091042 12:1 13:1 14:0 15:0 16:0 17:1 18:1 19:0 20:5 21:2.564949 22:0.000000 23:0.000000</span>
<span class="lineno">5</span> <span class="go">gX60q +1 1:2086220371355 2:1.774193 3:1 4:3.258097 5:3.784190 6:0.000000 7:0.000000 8:0.000000 9:0 10:0 11:3.258097 12:0 13:1 14:0 15:0 16:0 17:1 18:0 19:0 20:5 21:2.995732 22:0.000000 23:0.000000</span>
<span class="lineno">6</span> <span class="go">5HG4U -1 1:352013287143 2:1.689824 3:1 4:0.000000 5:0.693147 6:0.000000 7:0.000000 8:0.000000 9:0 10:1 11:1.791759 12:0 13:1 14:1 15:0 16:1 17:0 18:0 19:0 20:4 21:2.197225 22:0.000000 23:0.000000</span>
<span class="lineno">7</span> <span class="go">2</span>
<span class="lineno">8</span> <span class="go">PdxMK 1:340674897225 2:1.744152 3:1 4:5.023881 5:7.042286 6:0.000000 7:0.000000 8:0.000000 9:0 10:0 11:3.367296 12:0 13:1 14:0 15:0 16:0 17:0 18:0 19:0 20:12 21:4.499810 22:0.000000 23:0.000000</span>
<span class="lineno">9</span> <span class="go">ehZ0a 1:2090062840058 2:1.939101 3:1 4:3.258097 5:2.995732 6:75.000000 7:0.000000 8:0.000000 9:0 10:0 11:3.433987 12:0 13:1 14:0 15:0 16:1 17:0 18:0 19:0 20:3 21:2.639057 22:0.000000 23:0.000000</span></code></pre></div>

<p>This data is completely anonymized and extracted from real production data, and thus will not include the raw form of the
answers. We, however, have extracted as many features as we think are useful, and you can decide which features make sense to be included in your final algorithm. The actual labeling of a good answer and bad answer is done organically on our site, through human moderators.</p>

<p><strong>Output format (write to STDOUT)</strong>:</p>

<p>For each query, you should output q lines to stdout, representing the decision made by your classifier, whether each answer is good or not:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">&lt;answer-identifier&gt; &lt;+1 or -1&gt;</span></code></pre></div>

<p>For example:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="lineno">1</span> <span class="go">PdxMK +1</span>
<span class="lineno">2</span> <span class="go">ehZ0a -1</span></code></pre></div>

<p>You are given a relative large sample input dataset offline with its corresponding output to finetune your program with your ML libraries.  It can be downloaded here: http://qsf.cf.quoracdn.net/Quoraâ€¦</p>

<p><strong>Scoring</strong>:</p>

<p>Only one very large test dataset will be given for this problem online as input to your program for scoring.  This input data set will not be revealed to you.</p>

<p>Output for every classification is awarded points separately. The score for this problem will be the sum of points for each correct classification. To prevent naive solution credit (outputting all +1s, for example), points are awarded only after X correct classifications, where X is number of +1 answers or -1 answers (whichever is greater).</p>

<p><strong>Timing</strong>:</p>

<p>Your program should complete in minutes. Try to achieve as high an accuracy as possible with this constraint in mind.</p>

<h2 id="solution-with-decision-tree-learning">Solution with decision tree learning:</h2>

<p>Decision tree is a simple machine-learning method, completely transparent method of classifying observations, which, after training, look like a series of if-then statements arranged into a tree.</p>

<p>But before we dive in our decision tree, we should first model items, an item represent an observation, and should contain an id and value. Also each observations has certain parameters or coordinates that our model should also contain. we can also go a bit further and add some utilities that stores the highest and lowest values for this coordinates:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 2</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 3</span> <span class="sd">    Describe an item</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="sd">    @type id: string</span>
<span class="lineno"> 6</span> <span class="sd">    @param id: the id of the elemet</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="sd">    @type value: string</span>
<span class="lineno"> 9</span> <span class="sd">    @param value: the value of the item</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="sd">    @type coords: list</span>
<span class="lineno">12</span> <span class="sd">    @param coords: a list representing the parameters that locates the item</span>
<span class="lineno">13</span> <span class="sd">    &quot;&quot;&quot;</span>
<span class="lineno">14</span>     <span class="n">__highs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">15</span>     <span class="n">__lows</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">16</span> 
<span class="lineno">17</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="lineno">18</span>         <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
<span class="lineno">19</span>         <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span>
<span class="lineno">20</span>         <span class="bp">self</span><span class="o">.</span><span class="n">scaled_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:]</span>
<span class="lineno">21</span>         <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
<span class="lineno">22</span>         <span class="bp">self</span><span class="o">.</span><span class="n">__update_highs</span><span class="p">()</span>
<span class="lineno">23</span>         <span class="bp">self</span><span class="o">.</span><span class="n">__update_lows</span><span class="p">()</span>
<span class="lineno">24</span> 
<span class="lineno">25</span>     <span class="k">def</span> <span class="nf">__update_highs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">26</span>         <span class="k">if</span> <span class="n">Item</span><span class="o">.</span><span class="n">__highs</span> <span class="o">==</span> <span class="p">[]:</span>
<span class="lineno">27</span>             <span class="n">Item</span><span class="o">.</span><span class="n">__highs</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">9999999.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
<span class="lineno">28</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno">29</span>             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)):</span>
<span class="lineno">30</span>                 <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Item</span><span class="o">.</span><span class="n">__highs</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
<span class="lineno">31</span>                     <span class="n">Item</span><span class="o">.</span><span class="n">__highs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="lineno">32</span> 
<span class="lineno">33</span>     <span class="k">def</span> <span class="nf">__update_lows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">34</span>         <span class="k">if</span> <span class="n">Item</span><span class="o">.</span><span class="n">__lows</span> <span class="o">==</span> <span class="p">[]:</span>
<span class="lineno">35</span>             <span class="n">Item</span><span class="o">.</span><span class="n">__lows</span> <span class="o">=</span> <span class="p">[</span><span class="mf">9999999.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
<span class="lineno">36</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno">37</span>             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)):</span>
<span class="lineno">38</span>                 <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">Item</span><span class="o">.</span><span class="n">__lows</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
<span class="lineno">39</span>                     <span class="n">Item</span><span class="o">.</span><span class="n">__lows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="lineno">40</span> 
<span class="lineno">41</span>     <span class="k">def</span> <span class="nf">scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factors</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="lineno">42</span>         <span class="k">if</span> <span class="n">factors</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<span class="lineno">43</span>             <span class="bp">self</span><span class="o">.</span><span class="n">scaled_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Item</span><span class="o">.</span><span class="n">__lows</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="p">((</span><span class="n">Item</span><span class="o">.</span><span class="n">__highs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Item</span><span class="o">.</span><span class="n">__lows</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.0001</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">))]</span>
<span class="lineno">44</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno">45</span>             <span class="bp">self</span><span class="o">.</span><span class="n">scaled_coords</span> <span class="o">=</span> <span class="p">[((</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Item</span><span class="o">.</span><span class="n">__lows</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="p">((</span><span class="n">Item</span><span class="o">.</span><span class="n">__highs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Item</span><span class="o">.</span><span class="n">__lows</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.0001</span><span class="p">)</span> <span class="o">*</span> <span class="n">factors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">))]</span></code></pre></div>

<p>Now, that we have our observations modeled, we can start modeling our decision tree. The first step is to create a representation of a the nodes. Each node has five variables:  column or coordinate index, value of this coordinate, results stores a dictionary of results for this branch,  t_node and f_node which are the next nodes in the tree if the result is true or false, respectively.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 2</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 3</span> <span class="sd">    A node object in a decision tree</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="sd">    @type column: int</span>
<span class="lineno"> 6</span> <span class="sd">    @param column: the column index of the criteria to be tested</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="sd">    @type value: string</span>
<span class="lineno"> 9</span> <span class="sd">    @param value: the value that the column must match to get a true result</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="sd">    @type results: dict</span>
<span class="lineno">12</span> <span class="sd">    @param results: stores a dictionary of results for this branch. This is None for everything</span>
<span class="lineno">13</span> <span class="sd">                    except endpoints</span>
<span class="lineno">14</span> 
<span class="lineno">15</span> <span class="sd">    @type t_node: Node</span>
<span class="lineno">16</span> <span class="sd">    @param t_node: the next nodes in the tree if the result is true</span>
<span class="lineno">17</span> 
<span class="lineno">18</span> <span class="sd">    @type f_node: Node</span>
<span class="lineno">19</span> <span class="sd">    @param f_node: the next nodes in the tree if the result is false</span>
<span class="lineno">20</span> <span class="sd">    &quot;&quot;&quot;</span>
<span class="lineno">21</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">t_node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">f_node</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="lineno">22</span>         <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">col</span>
<span class="lineno">23</span>         <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
<span class="lineno">24</span>         <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span>
<span class="lineno">25</span>         <span class="bp">self</span><span class="o">.</span><span class="n">t_node</span> <span class="o">=</span> <span class="n">t_node</span>
<span class="lineno">26</span>         <span class="bp">self</span><span class="o">.</span><span class="n">f_node</span> <span class="o">=</span> <span class="n">f_node</span>
<span class="lineno">27</span> 
<span class="lineno">28</span>     <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
<span class="lineno">29</span>         <span class="c"># Is this a leaf node?</span>
<span class="lineno">30</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
<span class="lineno">31</span>             <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
<span class="lineno">32</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno">33</span>             <span class="c"># Print the criteria</span>
<span class="lineno">34</span>             <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;? &#39;</span>
<span class="lineno">35</span>             <span class="c"># Print the branches</span>
<span class="lineno">36</span>             <span class="k">print</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&#39;T-&gt;&#39;</span><span class="p">,</span>
<span class="lineno">37</span>             <span class="bp">self</span><span class="o">.</span><span class="n">t_node</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="s">&#39;  &#39;</span><span class="p">)</span>
<span class="lineno">38</span>             <span class="k">print</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&#39;F-&gt;&#39;</span><span class="p">,</span>
<span class="lineno">39</span>             <span class="bp">self</span><span class="o">.</span><span class="n">f_node</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="s">&#39;  &#39;</span><span class="p">)</span></code></pre></div>

<p>Now we need the decision tree methods, that will allow us to train and build the tree, classify and prune in case of an over fitting tree.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">  1</span> <span class="k">class</span> <span class="nc">DecisionTree</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno">  2</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno">  3</span> <span class="sd">    A decision tree object</span>
<span class="lineno">  4</span> <span class="sd">    &quot;&quot;&quot;</span>
<span class="lineno">  5</span> 
<span class="lineno">  6</span>     <span class="nd">@staticmethod</span>
<span class="lineno">  7</span>     <span class="k">def</span> <span class="nf">count_results</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
<span class="lineno">  8</span>         <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno">  9</span> <span class="sd">        count the occurrences of each result in the data set</span>
<span class="lineno"> 10</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno"> 11</span>         <span class="n">results_count</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="lineno"> 12</span>         <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
<span class="lineno"> 13</span>             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<span class="lineno"> 14</span>                 <span class="n">results_count</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="lineno"> 15</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno"> 16</span>             <span class="n">results_count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="lineno"> 17</span>         <span class="k">return</span> <span class="n">results_count</span>
<span class="lineno"> 18</span> 
<span class="lineno"> 19</span>     <span class="nd">@staticmethod</span>
<span class="lineno"> 20</span>     <span class="k">def</span> <span class="nf">divide_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="lineno"> 21</span>         <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 22</span> <span class="sd">        Divides a set of rows on a specific column.</span>
<span class="lineno"> 23</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno"> 24</span>         <span class="c">#a function that decides if the row goes to the first or the second group (true or false)</span>
<span class="lineno"> 25</span>         <span class="n">spliter</span> <span class="o">=</span> <span class="bp">None</span>
<span class="lineno"> 26</span>         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
<span class="lineno"> 27</span>             <span class="n">spliter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span><span class="n">item</span><span class="o">.</span><span class="n">scaled_coords</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">value</span>
<span class="lineno"> 28</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno"> 29</span>             <span class="n">spliter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span><span class="n">item</span><span class="o">.</span><span class="n">scaled_coords</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span>
<span class="lineno"> 30</span>         <span class="c">#divide the rows into two sets and return them</span>
<span class="lineno"> 31</span>         <span class="n">set_true</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno"> 32</span>         <span class="n">set_false</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno"> 33</span>         <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<span class="lineno"> 34</span>             <span class="k">if</span> <span class="n">spliter</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
<span class="lineno"> 35</span>                 <span class="n">set_true</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<span class="lineno"> 36</span>             <span class="k">else</span><span class="p">:</span>
<span class="lineno"> 37</span>                 <span class="n">set_false</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<span class="lineno"> 38</span>         <span class="k">return</span> <span class="p">(</span><span class="n">set_true</span><span class="p">,</span> <span class="n">set_false</span><span class="p">)</span>
<span class="lineno"> 39</span> 
<span class="lineno"> 40</span>     <span class="nd">@staticmethod</span>
<span class="lineno"> 41</span>     <span class="k">def</span> <span class="nf">gini_impurity</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
<span class="lineno"> 42</span>         <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 43</span> <span class="sd">        Probability that a randomly placed item will be in the wrong category</span>
<span class="lineno"> 44</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno"> 45</span>         <span class="n">results_count</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">count_results</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
<span class="lineno"> 46</span>         <span class="n">len_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="lineno"> 47</span>         <span class="n">imp</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="lineno"> 48</span>         <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">results_count</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
<span class="lineno"> 49</span>             <span class="n">p1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">/</span> <span class="n">len_data</span>
<span class="lineno"> 50</span>             <span class="k">for</span> <span class="n">k2</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">results_count</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
<span class="lineno"> 51</span>                 <span class="k">if</span> <span class="n">k1</span> <span class="o">==</span> <span class="n">k2</span><span class="p">:</span> <span class="k">continue</span>
<span class="lineno"> 52</span>                 <span class="n">p2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="n">len_data</span>
<span class="lineno"> 53</span>                 <span class="n">imp</span> <span class="o">+=</span> <span class="n">p1</span> <span class="o">*</span> <span class="n">p2</span>
<span class="lineno"> 54</span>         <span class="k">return</span> <span class="n">imp</span>
<span class="lineno"> 55</span> 
<span class="lineno"> 56</span>     <span class="nd">@staticmethod</span>
<span class="lineno"> 57</span>     <span class="k">def</span> <span class="nf">entropy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
<span class="lineno"> 58</span>         <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 59</span> <span class="sd">        estimate the disorder in the data set : sum of p(x)log(p(x))</span>
<span class="lineno"> 60</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno"> 61</span>         <span class="n">results_count</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">count_results</span><span class="p">(</span><span class="n">data</span> <span class="p">,</span> <span class="n">item</span><span class="p">)</span>
<span class="lineno"> 62</span>         <span class="n">len_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="lineno"> 63</span>         <span class="n">ent</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="lineno"> 64</span>         <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results_count</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
<span class="lineno"> 65</span>             <span class="n">p</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="n">len_data</span>
<span class="lineno"> 66</span>             <span class="n">ent</span> <span class="o">-=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">log2</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="lineno"> 67</span>         <span class="k">return</span> <span class="n">ent</span>
<span class="lineno"> 68</span> 
<span class="lineno"> 69</span>     <span class="nd">@staticmethod</span>
<span class="lineno"> 70</span>     <span class="k">def</span> <span class="nf">variance</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="lineno"> 71</span>         <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 72</span> <span class="sd">        calculates the statistical variance for a set of rows</span>
<span class="lineno"> 73</span> <span class="sd">        more preferably to be used with numerical outcomes</span>
<span class="lineno"> 74</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno"> 75</span>         <span class="n">len_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="lineno"> 76</span>         <span class="k">if</span> <span class="n">len_data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
<span class="lineno"> 77</span>         <span class="n">score</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
<span class="lineno"> 78</span>         <span class="n">mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
<span class="lineno"> 79</span>         <span class="n">variance</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([(</span><span class="n">s</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">score</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
<span class="lineno"> 80</span>         <span class="k">return</span> <span class="n">variance</span>
<span class="lineno"> 81</span> 
<span class="lineno"> 82</span> 
<span class="lineno"> 83</span>     <span class="nd">@staticmethod</span>
<span class="lineno"> 84</span>     <span class="k">def</span> <span class="nf">build_tree</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">disorder_function</span><span class="o">=</span><span class="s">&quot;entropy&quot;</span><span class="p">):</span>
<span class="lineno"> 85</span>         <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 86</span> <span class="sd">        a recursive function that builds the tree by choosing the best dividing criteria</span>
<span class="lineno"> 87</span> <span class="sd">        disorder_function :</span>
<span class="lineno"> 88</span> <span class="sd">            for data that contains words and booleans; it is recommended to use entropy or gini_impurity</span>
<span class="lineno"> 89</span> <span class="sd">            for data that contains number; it is recommended to use variance</span>
<span class="lineno"> 90</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno"> 91</span>         <span class="k">if</span> <span class="n">disorder_function</span> <span class="o">==</span> <span class="s">&quot;entropy&quot;</span><span class="p">:</span>
<span class="lineno"> 92</span>             <span class="n">disorder_estimator</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">entropy</span>
<span class="lineno"> 93</span>         <span class="k">elif</span> <span class="n">disorder_function</span> <span class="o">==</span> <span class="s">&quot;gini_impurity&quot;</span><span class="p">:</span>
<span class="lineno"> 94</span>             <span class="n">disorder_estimator</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">gini_impurity</span>
<span class="lineno"> 95</span>         <span class="k">elif</span> <span class="n">disorder_function</span> <span class="o">==</span> <span class="s">&quot;variance&quot;</span><span class="p">:</span>
<span class="lineno"> 96</span>             <span class="n">disorder_estimator</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">variance</span>
<span class="lineno"> 97</span>         <span class="n">len_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="lineno"> 98</span>         <span class="k">if</span> <span class="n">len_data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">Node</span><span class="p">()</span>
<span class="lineno"> 99</span>         <span class="n">current_disorder_level</span> <span class="o">=</span> <span class="n">disorder_estimator</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="lineno">100</span>         <span class="c"># track enhancement of disorer&#39;s level</span>
<span class="lineno">101</span>         <span class="n">best_enhancement</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="lineno">102</span>         <span class="n">best_split</span> <span class="o">=</span> <span class="bp">None</span>
<span class="lineno">103</span>         <span class="n">best_split_sets</span> <span class="o">=</span> <span class="bp">None</span>
<span class="lineno">104</span>         <span class="c">#number columns</span>
<span class="lineno">105</span>         <span class="n">nbr_coords</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scaled_coords</span><span class="p">)</span>
<span class="lineno">106</span>         <span class="k">for</span> <span class="n">coord_ind</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">nbr_coords</span><span class="p">):</span>
<span class="lineno">107</span>             <span class="c">#get unique values of the current column</span>
<span class="lineno">108</span>             <span class="n">coord_values</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno">109</span>             <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<span class="lineno">110</span>                 <span class="n">coord_values</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">scaled_coords</span><span class="p">[</span><span class="n">coord_ind</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="lineno">111</span>             <span class="k">for</span> <span class="n">coord_value</span> <span class="ow">in</span> <span class="n">coord_values</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
<span class="lineno">112</span>                 <span class="n">set1</span><span class="p">,</span> <span class="n">set2</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">divide_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">coord_ind</span><span class="p">,</span> <span class="n">coord_value</span><span class="p">)</span>
<span class="lineno">113</span>                 <span class="n">p1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">set1</span><span class="p">))</span> <span class="o">/</span> <span class="n">len_data</span>
<span class="lineno">114</span>                 <span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span>
<span class="lineno">115</span>                 <span class="n">enhancement</span> <span class="o">=</span> <span class="n">current_disorder_level</span> <span class="o">-</span> <span class="p">(</span><span class="n">p1</span> <span class="o">*</span> <span class="n">disorder_estimator</span><span class="p">(</span><span class="n">set1</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="n">p2</span> <span class="o">*</span> <span class="n">disorder_estimator</span><span class="p">(</span><span class="n">set2</span><span class="p">))</span>
<span class="lineno">116</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">enhancement</span> <span class="o">&gt;</span> <span class="n">best_enhancement</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">set1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">set2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
<span class="lineno">117</span>                     <span class="n">best_enhancement</span> <span class="o">=</span> <span class="n">enhancement</span>
<span class="lineno">118</span>                     <span class="n">best_split</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord_ind</span><span class="p">,</span> <span class="n">coord_value</span><span class="p">)</span>
<span class="lineno">119</span>                     <span class="n">best_split_sets</span> <span class="o">=</span> <span class="p">(</span><span class="n">set1</span><span class="p">,</span> <span class="n">set2</span><span class="p">)</span>
<span class="lineno">120</span>         <span class="k">if</span> <span class="n">best_enhancement</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">121</span>             <span class="n">t_node</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">build_tree</span><span class="p">(</span><span class="n">best_split_sets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="lineno">122</span>             <span class="n">f_node</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">build_tree</span><span class="p">(</span><span class="n">best_split_sets</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="lineno">123</span>             <span class="k">return</span> <span class="n">Node</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="n">best_split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">best_split</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<span class="lineno">124</span>                                     <span class="n">t_node</span><span class="o">=</span><span class="n">t_node</span><span class="p">,</span> <span class="n">f_node</span><span class="o">=</span><span class="n">f_node</span><span class="p">)</span>
<span class="lineno">125</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno">126</span>             <span class="k">return</span> <span class="n">Node</span><span class="p">(</span><span class="n">results</span><span class="o">=</span><span class="n">DecisionTree</span><span class="o">.</span><span class="n">count_results</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="lineno">127</span> 
<span class="lineno">128</span>     <span class="nd">@staticmethod</span>
<span class="lineno">129</span>     <span class="k">def</span> <span class="nf">prune</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">min_enhancement</span><span class="p">,</span> <span class="n">disorder_function</span><span class="o">=</span><span class="s">&quot;entropy&quot;</span><span class="p">):</span>
<span class="lineno">130</span>         <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno">131</span> <span class="sd">        checking pairs of nodes that have a common parent to see if merging</span>
<span class="lineno">132</span> <span class="sd">        them would increase the entropy by less than a specified threshold</span>
<span class="lineno">133</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno">134</span>         <span class="k">if</span> <span class="n">disorder_function</span> <span class="o">==</span> <span class="s">&quot;entropy&quot;</span><span class="p">:</span>
<span class="lineno">135</span>             <span class="n">disorder_estimator</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">entropy</span>
<span class="lineno">136</span>         <span class="k">elif</span> <span class="n">disorder_function</span> <span class="o">==</span> <span class="s">&quot;gini_impurity&quot;</span><span class="p">:</span>
<span class="lineno">137</span>             <span class="n">disorder_estimator</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">gini_impurity</span>
<span class="lineno">138</span>         <span class="k">elif</span> <span class="n">disorder_function</span> <span class="o">==</span> <span class="s">&quot;variance&quot;</span><span class="p">:</span>
<span class="lineno">139</span>             <span class="n">disorder_estimator</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">variance</span>
<span class="lineno">140</span>         <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="n">t_node</span><span class="o">.</span><span class="n">results</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
<span class="lineno">141</span>             <span class="n">DecisionTree</span><span class="o">.</span><span class="n">prune</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">t_node</span><span class="p">,</span> <span class="n">min_enhancement</span><span class="p">)</span>
<span class="lineno">142</span>         <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="n">f_node</span><span class="o">.</span><span class="n">results</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
<span class="lineno">143</span>             <span class="n">DecisionTree</span><span class="o">.</span><span class="n">prune</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">f_node</span><span class="p">,</span> <span class="n">min_enhancement</span><span class="p">)</span>
<span class="lineno">144</span>         <span class="c"># If both the subbranches are now leaves, see if they should merged</span>
<span class="lineno">145</span>         <span class="k">if</span> <span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">t_node</span><span class="o">.</span><span class="n">results</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">tree</span><span class="o">.</span><span class="n">f_node</span><span class="o">.</span><span class="n">results</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
<span class="lineno">146</span>             <span class="c"># Build a combined dataset</span>
<span class="lineno">147</span>             <span class="n">t_node</span><span class="p">,</span> <span class="n">f_node</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="lineno">148</span>             <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">t_node</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="lineno">149</span>                 <span class="n">t_node</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">key</span><span class="p">]]</span> <span class="o">*</span> <span class="n">value</span>
<span class="lineno">150</span>             <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">f_node</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="lineno">151</span>                 <span class="n">f_node</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">key</span><span class="p">]]</span> <span class="o">*</span> <span class="n">value</span>
<span class="lineno">152</span>             <span class="c"># Test the enhancement</span>
<span class="lineno">153</span>             <span class="n">delta</span> <span class="o">=</span> <span class="n">disorder_estimator</span><span class="p">(</span><span class="n">t_node</span> <span class="o">+</span> <span class="n">f_node</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">disorder_estimator</span><span class="p">(</span><span class="n">t_node</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">+</span> <span class="n">disorder_estimator</span><span class="p">(</span><span class="n">f_node</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="lineno">154</span>             <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="n">min_enhancement</span><span class="p">:</span>
<span class="lineno">155</span>                 <span class="c"># Merge the branches</span>
<span class="lineno">156</span>                 <span class="n">tree</span><span class="o">.</span><span class="n">t_node</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">f_node</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
<span class="lineno">157</span>                 <span class="n">tree</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">count_results</span><span class="p">(</span><span class="n">t_node</span> <span class="o">+</span> <span class="n">f_node</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="lineno">158</span> 
<span class="lineno">159</span>     <span class="nd">@staticmethod</span>
<span class="lineno">160</span>     <span class="k">def</span> <span class="nf">classify</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
<span class="lineno">161</span>         <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno">162</span> <span class="sd">        Classify a new observation given a decision tree</span>
<span class="lineno">163</span> <span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno">164</span>         <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="n">results</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
<span class="lineno">165</span>             <span class="k">return</span> <span class="n">tree</span><span class="o">.</span><span class="n">results</span>
<span class="lineno">166</span>         <span class="c">#the observation value for the current criteria column</span>
<span class="lineno">167</span>         <span class="n">observation_value</span> <span class="o">=</span> <span class="n">observation</span><span class="o">.</span><span class="n">scaled_coords</span><span class="p">[</span><span class="n">tree</span><span class="o">.</span><span class="n">col</span><span class="p">]</span>
<span class="lineno">168</span>         <span class="k">if</span> <span class="n">observation_value</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
<span class="lineno">169</span>             <span class="n">t_results</span><span class="p">,</span> <span class="n">f_results</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">t_node</span><span class="p">),</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">f_node</span><span class="p">)</span>
<span class="lineno">170</span>             <span class="n">t_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t_results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="lineno">171</span>             <span class="n">f_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f_results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="lineno">172</span>             <span class="n">t_prob</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t_count</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t_count</span> <span class="o">+</span> <span class="n">f_count</span><span class="p">)</span>
<span class="lineno">173</span>             <span class="n">f_prob</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_count</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t_count</span> <span class="o">+</span> <span class="n">f_count</span><span class="p">)</span>
<span class="lineno">174</span>             <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno">175</span>             <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">t_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="n">t_prob</span>
<span class="lineno">176</span>             <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">f_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="n">f_prob</span>
<span class="lineno">177</span>             <span class="k">return</span> <span class="n">result</span>
<span class="lineno">178</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno">179</span>             <span class="c">#with branch to follow</span>
<span class="lineno">180</span>             <span class="n">branch</span> <span class="o">=</span> <span class="bp">None</span>
<span class="lineno">181</span>             <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observation_value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">observation_value</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<span class="lineno">182</span>                 <span class="n">branch</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">t_node</span> <span class="k">if</span> <span class="p">(</span><span class="n">observation_value</span> <span class="o">&gt;=</span> <span class="n">tree</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">else</span> <span class="n">tree</span><span class="o">.</span><span class="n">f_node</span>
<span class="lineno">183</span>             <span class="k">else</span><span class="p">:</span>
<span class="lineno">184</span>                 <span class="n">branch</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">t_node</span> <span class="k">if</span> <span class="p">(</span><span class="n">observation_value</span> <span class="o">==</span> <span class="n">tree</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">else</span> <span class="n">tree</span><span class="o">.</span><span class="n">f_node</span>
<span class="lineno">185</span>             <span class="k">return</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">observation</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span></code></pre></div>

<p>Finally the utilities to read the test and results :</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="n">r_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;test.txt&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
<span class="lineno"> 2</span> <span class="n">w_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;results.txt&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
<span class="lineno"> 3</span> <span class="n">N</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
<span class="lineno"> 4</span> <span class="n">training_set</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno"> 5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<span class="lineno"> 6</span>     <span class="n">current_line</span> <span class="o">=</span> <span class="n">r_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="lineno"> 7</span>     <span class="nb">id</span> <span class="o">=</span> <span class="n">current_line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="lineno"> 8</span>     <span class="n">value</span> <span class="o">=</span> <span class="n">current_line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="lineno"> 9</span>     <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">current_line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
<span class="lineno">10</span>     <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="n">M</span>
<span class="lineno">11</span>     <span class="c">#coords=[coords[i] for i in xrange(M) if i in [1, 2, 4, 6, 7, 11, 14, 18]]</span>
<span class="lineno">12</span>     <span class="n">training_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">))</span>
<span class="lineno">13</span> <span class="n">Q</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>
<span class="lineno">14</span> <span class="n">classify_set</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">15</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">Q</span><span class="p">):</span>
<span class="lineno">16</span>     <span class="n">current_line</span> <span class="o">=</span> <span class="n">r_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="lineno">17</span>     <span class="nb">id</span> <span class="o">=</span> <span class="n">current_line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="lineno">18</span>     <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">current_line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
<span class="lineno">19</span>     <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="n">M</span>
<span class="lineno">20</span>     <span class="c">#coords=[coords[i] for i in xrange(M) if i in [1, 2, 4, 6, 7, 11, 14, 18]]</span>
<span class="lineno">21</span>     <span class="n">classify_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">))</span>
<span class="lineno">22</span> <span class="c">#reading the results</span>
<span class="lineno">23</span> <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno">24</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">Q</span><span class="p">):</span>
<span class="lineno">25</span>     <span class="n">current_line</span> <span class="o">=</span> <span class="n">w_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="lineno">26</span>     <span class="n">results</span><span class="p">[</span><span class="n">current_line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">current_line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="lineno">27</span> 
<span class="lineno">28</span> <span class="n">d</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="p">()</span>
<span class="lineno">29</span> <span class="n">node</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">build_tree</span><span class="p">(</span><span class="n">training_set</span><span class="p">)</span>
<span class="lineno">30</span> <span class="n">correct</span><span class="o">=</span><span class="mi">0</span>
<span class="lineno">31</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">classify_set</span><span class="p">:</span>
<span class="lineno">32</span>     <span class="n">cr</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
<span class="lineno">33</span>     <span class="k">if</span> <span class="n">cr</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">results</span><span class="p">[</span><span class="n">obs</span><span class="o">.</span><span class="n">id</span><span class="p">]:</span>
<span class="lineno">34</span>         <span class="n">correct</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="lineno">35</span> <span class="k">print</span> <span class="n">correct</span></code></pre></div>


            
<div class="social">
  
  <div class='twitter'>
    <a href="https://twitter.com/share" class="twitter-share-button"  data-text="Quora Answer Classifier (Part 1, with decision tree learning)." data-related="mmourafiq">Tweet</a>
  </div>
  

  
  <div class='facebook'>
    <div class="fb-share-button" data-layout="button_count"></div>
  </div>
  

  
  <div class='google'>
    <div class="g-plusone" data-size="medium"></div>
  </div>
  
    
  
  <div class='hn'>
    <a href="https://news.ycombinator.com/submit" class="hn-button" data-title="Quora Answer Classifier (Part 1, with decision tree learning)." data-url="http://mourafiq.com/2012/11/15/quora-answer-classifier-1.html" data-count="horizontal">Vote on Hacker News</a>
  </div>
  

  
  <div class='reddit'>
    <a href="//www.reddit.com/submit" onclick="window.open('//www.reddit.com/submit?url=http://mourafiq.com/2012/11/15/quora-answer-classifier-1.html&title=Quora+Answer+Classifier+%28Part+1%2C+with+decision+tree+learning%29.'); return false"> <img src="//www.redditstatic.com/spreddit7.gif" alt="submit to reddit" border="0" /> </a>
  </div>
  
</div>

        </section>

        <footer>
            <address>
                <img src="/images/logo.png">
                <p>
                Written by <strong><a rel="author" href="https://twitter.com/mmourafiq." title="Mourad Mourafiq." target="_blank">Mourad Mourafiq.</a></strong><br>
                    <span class="muted">Maths, Technology, Philosophy, Startups, ...</span>
                </p>
            </address>
            
            
            <section class="post_summary">
                <h3 class="title">Next up: <a href="/2012/12/01/quora-answer-classifier-2.html" rel="prefetch">Quora Answer Classifier (Part 2, with KNN).</a></h3>
                <p>Designing an algorithm to develop classifier that is able to tell good answers from bad answers, as well as humans can.</p>
                <hr>
            </section>
             
            
            
            <section class="post_summary">
                <h3 class="title">Previous story: <a href="/2012/11/01/quora-type-ahead.html" rel="prefetch">Quora Typeahead search.</a></h3>
                <p>Designing an algorithm to return the most relevant results that match the search query entered into the input text field.</p>
                <hr>
            </section>
             
            
            <section>
                <div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'mourafiq';

  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
            </section>
            
        </footer>
    </div>
</article>


    <footer class="site-footer">
        <div class="container">
            &copy; 2015 Mourad Mourafiq

            <nav>
                <a href="/">Blog</a> &middot;
                <a href="/about.html">About</a>
            </nav>

            <nav class="social">
                
<a href="https://twitter.com/mmourafiq" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter"></i></a>


<a href="https://github.com/mouradmourafiq" title="Watch on Github" target="_blank"><i class="icon icon-github"></i></a>


<a href="/atom.xml" title="RSS Feed">
  <i class="icon icon-rss"></i>
</a>

            </nav>
            <div>Based on Incorporated theme by <a href="https://sendtoinc.com">Inc</a></div>
        </div>
    </footer>

</body>
</html>
