<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quora Nearby. &mdash; Mourad Mourafiq</title>
    <!--[if lt IE 9]><script src='https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js'></script><![endif]-->
    
    <link rel="stylesheet" href="/assets/app.css">
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>

<script>
  var HN=[];HN.factory=function(e){return function(){HN.push([e].concat(Array.prototype.slice.call(arguments,0)))};},HN.on=HN.factory("on"),HN.once=HN.factory("once"),HN.off=HN.factory("off"),HN.emit=HN.factory("emit"),HN.load=function(){var e="hn-button.js";if(document.getElementById(e))return;var t=document.createElement("script");t.id=e,t.src="//hn-button.herokuapp.com/hn-button.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n)},HN.load();</script>
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-34892053-1', 'auto');
  ga('send', 'pageview');
</script>



    <link rel="shortcut icon" href="/favicon.ico?v2" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Mourad Mourafiq" href="/atom.xml" />
    <meta name="title" content="Quora Nearby. ">
    <link rel="canonical" href="http://mourafiq.com/2012/10/15/quora-nearby.html">
    <meta property="og:title" content="Quora Nearby."/>
    <meta property="og:url" content="http://mourafiq.com/2012/10/15/quora-nearby.html"/>
    <meta property="og:image" content="http://mourafiq.com/images/posts/quora.png"/>
    
    <meta property="og:description" content="Designing an algorithm to find topics or questions that are near to a given input location, up to a specified limit."/>
    <meta name="description" content="Designing an algorithm to find topics or questions that are near to a given input location, up to a specified limit."/>
    
    <meta property="og:site_name" content="Mourad Mourafiq">
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>

<body>

    <header class="site-header">
        <nav>
            <a class="brand" href="/">
                <img src="/images/logo.png" alt="Inc">
            </a>
            <a href="/about.html">About</a>
        </nav>
    </header>

    
<div class="cover  article-cover " style="background-image:url(/images/posts/quora.png)"></div>


<div class='cover-caption'><a href='/about.html#pictures'>Quora</a></div>


<article >
    <div class="container">
        <header>
            
            <div class="meta">
                <!--
                By
                <address><a rel="author" href="" title="Mourad Mourafiq." target="_blank">
                    Mourad Mourafiq.
                </a></address> &mdash;
                -->
                <time pubdate datetime="2012-15-October" title="Oct 15, 2012">
                    Oct 15, 2012
                </time> &mdash;
                
33 min read
            </div>
            
            <h1 class="title">Quora Nearby.</h1>
            <h2 class="subtitle">Designing an algorithm to find topics or questions that are near to a given input location, up to a specified limit.</h2>
        </header>

        <section>
            <p>Topics on Quora have location data optionally associated with them, allowing the Quora Nearby feature for our iPhone app. Each question on Quora can have one or more topics associated with it. This feature allows us to display topics and questions near different locations, be it the user’s current location, or a specified location on the map.</p>

<p><img src="/images/posts/quora-nearby.png" alt="quora-feed-optimizer" /></p>

<p>Your task will be to write a program that will be able to find topics or questions that are near to a given input location, up to a specified limit.</p>

<p>Input format (read from STDIN):
The first line of input will be 3 integers: number of topics T, number of questions Q, and number of queries N.</p>

<p>There will be T lines following that, each with a topic id integer, and two doubles representing that topic’s location (you can consider the points to be located on a XY plane, location of a entity is in form of its x and y coordinate in the plane).</p>

<p>There will be Q lines following that, each with a question id integer and number of topics the question is associated with, Qn, followed by Qn number of topic ids associated with that question. These integers are guaranteed to be well-formed existing topics.  There may be 0 topics associated with a question, and in such cases, the question should never appear in the query results.</p>

<p>The next N lines will consist of a char, an integer and two doubles each, representing the type of results required (“t” for topic or “q” for question), the number of results required, and the location to be used as the query.</p>

<p><strong>Sample Input</strong>:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="lineno"> 1</span> <span class="go">3 6 2</span>
<span class="lineno"> 2</span> <span class="go">0 0.0 0.0</span>
<span class="lineno"> 3</span> <span class="go">1 1.0 1.0</span>
<span class="lineno"> 4</span> <span class="go">2 2.0 2.0</span>
<span class="lineno"> 5</span> <span class="go">0 1 0</span>
<span class="lineno"> 6</span> <span class="go">1 2 0 1</span>
<span class="lineno"> 7</span> <span class="go">2 3 0 1 2</span>
<span class="lineno"> 8</span> <span class="go">3 0</span>
<span class="lineno"> 9</span> <span class="go">4 0</span>
<span class="lineno">10</span> <span class="go">5 2 1 2</span>
<span class="lineno">11</span> <span class="go">t 2 0.0 0.0</span>
<span class="lineno">12</span> <span class="go">q 5 100.0 100.0</span></code></pre></div>

<p><strong>Output format (write to STDOUT)</strong>:</p>

<p>For each query line given in the input, you are to output the ids of the nearest entities in ascending order of distance from the query location, up to the specified number of results.  When there is a tie between different entities in the ordering due to equal distances (threshold of 0.001 for equality comparisons), the entity with the larger id should be ranked first.</p>

<p>Distance of a question from a point is the minimum of the distance of all topics associated with that question.</p>

<p>Sample Output:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="lineno">1</span> <span class="go">1</span>
<span class="lineno">2</span> <span class="go">2</span>
<span class="lineno">3</span> <span class="go">0 1</span>
<span class="lineno">4</span> <span class="go">5 2 1 0</span></code></pre></div>

<p>Explanation:</p>

<p>There are 3 topics with ids 0, 1 and 2. There are also 6 questions, with ids 0 to 5. We first ask a nearest topic query.</p>

<p>The closest 2 topics to (0.0, 0.0) are topics 0 and 1.</p>

<p>The next query asks for upto 5 closest questions to (100.0, 100.0). Since questions 5 and 2 are tagged with topic 2</p>

<p>located at (2.0, 2.0), they are closest to the query location.</p>

<p>Because of the tie in distance, we put question 5 before question 2.</p>

<p>The next closest question is question 1, followed by question 0.</p>

<p>We do not output questions 3 or 4 because there are no topics associated with them.</p>

<p>Constraints:</p>

<ul>
  <li>1 &lt;= T &lt;= 10000</li>
  <li>1 &lt;= Q &lt;= 1000</li>
  <li>1 &lt;= N &lt;= 10000</li>
</ul>

<p>Integer ids are between 0 and 100000 inclusive.</p>

<p>Number of topics associated with a question is not more than 10.</p>

<p>The number of results required for a query is not more than 100.</p>

<p>0.0 &lt;= x,y &lt;= 1000000.0 (10^6)</p>

<p>For the large testcases, all topic x,y co-ordinates will be approximately uniformly distributed over the bounds.</p>

<p>You should aim to have your algorithm be fast enough to solve our largest test inputs in under 5 seconds, or be as close to that as possible.</p>

<h2 id="my-solutions">My Solutions:</h2>

<p>The first solution that I propose is a naive approach that sort all entities each time we make a query.</p>

<p>First we need to create the topic model, we should also be able to calculate the distance between this topic and the current origin, which is the query coordinates.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">Topic</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 2</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 3</span> <span class="sd">    Topic</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="sd">    @type _id: int</span>
<span class="lineno"> 6</span> <span class="sd">    @param _id: the id of the topic</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="sd">    @type _x: float</span>
<span class="lineno"> 9</span> <span class="sd">    @param _x: the x coordinate in the plane</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="sd">    @type _y: float</span>
<span class="lineno">12</span> <span class="sd">    @param _y: the y coordinate in the plane</span>
<span class="lineno">13</span> 
<span class="lineno">14</span> <span class="sd">    @type _current_distance: float</span>
<span class="lineno">15</span> <span class="sd">    @param _current_distance: the current distance from the origin(origin being the query coordiantaes)</span>
<span class="lineno">16</span> 
<span class="lineno">17</span> <span class="sd">    @type _qn: int</span>
<span class="lineno">18</span> <span class="sd">    @param _qn: the number of questions associated with this topics</span>
<span class="lineno">19</span> 
<span class="lineno">20</span> <span class="sd">    @type _questions: list</span>
<span class="lineno">21</span> <span class="sd">    @param _questions: the list of the questions associated with this topic</span>
<span class="lineno">22</span> <span class="sd">    &quot;&quot;&quot;</span>
<span class="lineno">23</span> 
<span class="lineno">24</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="lineno">25</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="nb">id</span>
<span class="lineno">26</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">x</span>
<span class="lineno">27</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y</span>
<span class="lineno">28</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_current_distance</span> <span class="o">=</span> <span class="mi">0</span>
<span class="lineno">29</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_qn</span> <span class="o">=</span> <span class="mi">0</span>
<span class="lineno">30</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_questions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">31</span> 
<span class="lineno">32</span>     <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">):</span>
<span class="lineno">33</span>         <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_distance</span> <span class="o">-</span> <span class="n">topic</span><span class="o">.</span><span class="n">_current_distance</span>
<span class="lineno">34</span>         <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">THRESHOLD</span><span class="p">:</span>
<span class="lineno">35</span>             <span class="k">return</span> <span class="bp">True</span>
<span class="lineno">36</span>         <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="n">THRESHOLD</span><span class="p">:</span>
<span class="lineno">37</span>             <span class="k">return</span> <span class="bp">False</span>
<span class="lineno">38</span>         <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">&gt;</span> <span class="n">topic</span><span class="o">.</span><span class="n">_id</span> <span class="k">else</span> <span class="bp">False</span>
<span class="lineno">39</span> 
<span class="lineno">40</span>     <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">):</span>
<span class="lineno">41</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_qn</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="lineno">42</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_questions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
<span class="lineno">43</span> 
<span class="lineno">44</span>     <span class="k">def</span> <span class="nf">get_questions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qn</span><span class="p">,</span> <span class="n">questions</span><span class="p">):</span>
<span class="lineno">45</span>         <span class="n">go_on</span> <span class="o">=</span> <span class="bp">True</span>
<span class="lineno">46</span>         <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_questions</span><span class="p">:</span>
<span class="lineno">47</span>             <span class="k">if</span> <span class="n">question</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">questions</span><span class="p">:</span>
<span class="lineno">48</span>                 <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
<span class="lineno">49</span>                 <span class="n">qn</span> <span class="o">-=</span> <span class="mi">1</span>
<span class="lineno">50</span>                 <span class="k">if</span> <span class="n">qn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">51</span>                     <span class="n">go_on</span> <span class="o">=</span> <span class="bp">False</span>
<span class="lineno">52</span>                     <span class="k">break</span>
<span class="lineno">53</span>         <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">questions</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">qn</span><span class="p">,</span> <span class="n">go_on</span>
<span class="lineno">54</span> 
<span class="lineno">55</span>     <span class="k">def</span> <span class="nf">set_current_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_x</span><span class="p">,</span> <span class="n">origin_y</span><span class="p">):</span>
<span class="lineno">56</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_current_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">euclidean_dis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">,</span> <span class="n">origin_x</span><span class="p">,</span> <span class="n">origin_y</span><span class="p">)</span>
<span class="lineno">57</span> 
<span class="lineno">58</span>     <span class="nd">@staticmethod</span>
<span class="lineno">59</span>     <span class="k">def</span> <span class="nf">euclidean_dis</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
<span class="lineno">60</span>         <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span></code></pre></div>

<p>Next we need to create the utility that allows to add topics and questions, and process queries.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">Nearby</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 2</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 3</span> <span class="sd">    Nearby solver</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="sd">    @type _tn: int</span>
<span class="lineno"> 6</span> <span class="sd">    @param _tn: the number of topics created</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="sd">    @type _topics: dict</span>
<span class="lineno"> 9</span> <span class="sd">    @param _topics: the dictionary of topics created  </span>
<span class="lineno">10</span> <span class="sd">    &quot;&quot;&quot;</span>
<span class="lineno">11</span> 
<span class="lineno">12</span> 
<span class="lineno">13</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tn</span><span class="p">):</span>
<span class="lineno">14</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span> <span class="o">=</span> <span class="n">tn</span>
<span class="lineno">15</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno">16</span> 
<span class="lineno">17</span>     <span class="k">def</span> <span class="nf">add_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic_id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="lineno">18</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="p">[</span><span class="n">topic_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">Topic</span><span class="p">(</span><span class="n">topic_id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="lineno">19</span> 
<span class="lineno">20</span>     <span class="k">def</span> <span class="nf">add_question</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">nbr_topics</span><span class="p">,</span> <span class="n">topics</span><span class="p">):</span>
<span class="lineno">21</span>         <span class="k">if</span> <span class="n">nbr_topics</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">22</span>             <span class="k">return</span>
<span class="lineno">23</span>         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">nbr_topics</span><span class="p">):</span>
<span class="lineno">24</span>             <span class="n">topic_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">topics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="lineno">25</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="p">[</span><span class="n">topic_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
<span class="lineno">26</span> 
<span class="lineno">27</span>     <span class="k">def</span> <span class="nf">_process_query_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbr_results</span><span class="p">,</span> <span class="n">list_topics</span><span class="p">):</span>
<span class="lineno">28</span>         <span class="k">if</span> <span class="n">nbr_results</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span><span class="p">:</span>
<span class="lineno">29</span>             <span class="n">nbr_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span>
<span class="lineno">30</span>         <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">list_topics</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">nbr_results</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
<span class="lineno">31</span> 
<span class="lineno">32</span>     <span class="k">def</span> <span class="nf">_process_query_question</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbr_results</span><span class="p">,</span> <span class="n">list_topics</span><span class="p">):</span>
<span class="lineno">33</span>         <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">34</span>         <span class="n">go_on</span> <span class="o">=</span> <span class="bp">True</span>
<span class="lineno">35</span>         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tn</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<span class="lineno">36</span>             <span class="n">results</span><span class="p">,</span> <span class="n">nbr_results</span><span class="p">,</span> <span class="n">go_on</span> <span class="o">=</span> <span class="n">list_topics</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_questions</span><span class="p">(</span><span class="n">nbr_results</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
<span class="lineno">37</span>             <span class="k">if</span> <span class="ow">not</span> <span class="n">go_on</span><span class="p">:</span>
<span class="lineno">38</span>                 <span class="k">break</span>
<span class="lineno">39</span>         <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
<span class="lineno">40</span> 
<span class="lineno">41</span>     <span class="k">def</span> <span class="nf">process_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_type</span><span class="p">,</span> <span class="n">q_nbr_results</span><span class="p">,</span> <span class="n">q_x</span><span class="p">,</span> <span class="n">q_y</span><span class="p">):</span>
<span class="lineno">42</span>         <span class="n">list_topics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">43</span>         <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
<span class="lineno">44</span>             <span class="n">topic</span><span class="o">.</span><span class="n">set_current_distance</span><span class="p">(</span><span class="n">q_x</span><span class="p">,</span> <span class="n">q_y</span><span class="p">)</span>
<span class="lineno">45</span>             <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">list_topics</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
<span class="lineno">46</span>         <span class="k">if</span> <span class="n">q_type</span> <span class="o">==</span> <span class="s">&quot;t&quot;</span><span class="p">:</span>
<span class="lineno">47</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_query_topic</span><span class="p">(</span><span class="n">q_nbr_results</span><span class="p">,</span> <span class="n">list_topics</span><span class="p">)</span>
<span class="lineno">48</span>         <span class="k">if</span> <span class="n">q_type</span> <span class="o">==</span> <span class="s">&quot;q&quot;</span><span class="p">:</span>
<span class="lineno">49</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_query_question</span><span class="p">(</span><span class="n">q_nbr_results</span><span class="p">,</span> <span class="n">list_topics</span><span class="p">)</span></code></pre></div>

<p>Note that for performance purpose we are using the heap data-structure.</p>

<p>To go a little bit further we can easily think of a data structure to divide the space of topics, I created an easy to use data structure Square that represents a part of the plane</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">Square</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 2</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 3</span> <span class="sd">    Square is data structure that represents a part of the plane.</span>
<span class="lineno"> 4</span> <span class="sd">    A square is divided to 4 parts.</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> <span class="sd">    @type _origine_x: float</span>
<span class="lineno"> 7</span> <span class="sd">    @param _origine_x: the x coordinate of the origine of this square</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="sd">    @type _origine_y: float</span>
<span class="lineno">10</span> <span class="sd">    @param _origine_y: the y coordinate of the origine of this square</span>
<span class="lineno">11</span> 
<span class="lineno">12</span> <span class="sd">    @type _curent_distance: int</span>
<span class="lineno">13</span> <span class="sd">    @param _curent_distance: current distance from the query coordiantes</span>
<span class="lineno">14</span> 
<span class="lineno">15</span> <span class="sd">    @type _tn: int</span>
<span class="lineno">16</span> <span class="sd">    @param _tn: numbre of points in this square  </span>
<span class="lineno">17</span> 
<span class="lineno">18</span> <span class="sd">    @type _topics: list</span>
<span class="lineno">19</span> <span class="sd">    @param _topics: list of topics</span>
<span class="lineno">20</span> <span class="sd">    &quot;&quot;&quot;</span>
<span class="lineno">21</span> 
<span class="lineno">22</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origine_x</span><span class="p">,</span> <span class="n">origine_y</span><span class="p">):</span>
<span class="lineno">23</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_origine_x</span> <span class="o">=</span> <span class="n">origine_x</span>
<span class="lineno">24</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_origine_y</span> <span class="o">=</span> <span class="n">origine_y</span>
<span class="lineno">25</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_current_distance</span> <span class="o">=</span> <span class="mi">0</span>
<span class="lineno">26</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span> <span class="o">=</span> <span class="mi">0</span>
<span class="lineno">27</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">28</span> 
<span class="lineno">29</span>     <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">square</span><span class="p">):</span>
<span class="lineno">30</span>         <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_distance</span> <span class="o">-</span> <span class="n">square</span><span class="o">.</span><span class="n">_current_distance</span>
<span class="lineno">31</span>         <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">32</span>             <span class="k">return</span> <span class="bp">True</span>
<span class="lineno">33</span>         <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">34</span>             <span class="k">return</span> <span class="bp">False</span>
<span class="lineno">35</span> 
<span class="lineno">36</span>     <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">):</span>
<span class="lineno">37</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="lineno">38</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
<span class="lineno">39</span> 
<span class="lineno">40</span>     <span class="k">def</span> <span class="nf">set_current_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_x</span><span class="p">,</span> <span class="n">origin_y</span><span class="p">):</span>
<span class="lineno">41</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_current_distance</span> <span class="o">=</span> <span class="n">Topic</span><span class="o">.</span><span class="n">euclidean_dis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_origine_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_origine_y</span><span class="p">,</span> <span class="n">origin_x</span><span class="p">,</span> <span class="n">origin_y</span><span class="p">)</span>
<span class="lineno">42</span>         <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="p">:</span>
<span class="lineno">43</span>             <span class="n">topic</span><span class="o">.</span><span class="n">set_current_distance</span><span class="p">(</span><span class="n">origin_x</span><span class="p">,</span> <span class="n">origin_y</span><span class="p">)</span>
<span class="lineno">44</span> 
<span class="lineno">45</span>     <span class="k">def</span> <span class="nf">get_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tn</span><span class="p">):</span>
<span class="lineno">46</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span> <span class="o">&gt;=</span> <span class="n">tn</span><span class="p">:</span>
<span class="lineno">47</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="p">[:</span><span class="n">tn</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">False</span>
<span class="lineno">48</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno">49</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="p">,</span> <span class="n">tn</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_tn</span><span class="p">,</span> <span class="bp">True</span></code></pre></div>

<p>This data structure will enable us to perform the sort part only on squares and not on all topics.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">NearbySquare</span><span class="p">(</span><span class="n">Nearby</span><span class="p">):</span>
<span class="lineno"> 2</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 3</span> <span class="sd">    Nearby solver using the square data structure</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="sd">    @type _tn: int</span>
<span class="lineno"> 6</span> <span class="sd">    @param _tn: the number of topics created</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="sd">    @type _topics: dict</span>
<span class="lineno"> 9</span> <span class="sd">    @param _topics: the dictionary of topics created</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="sd">    @type _squares: dict</span>
<span class="lineno">12</span> <span class="sd">    @param _squares: the dictionary of squares created  </span>
<span class="lineno">13</span> <span class="sd">    &quot;&quot;&quot;</span>
<span class="lineno">14</span> 
<span class="lineno">15</span> 
<span class="lineno">16</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tn</span><span class="p">):</span>
<span class="lineno">17</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span> <span class="o">=</span> <span class="n">tn</span>
<span class="lineno">18</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_ts</span> <span class="o">=</span> <span class="mi">0</span>
<span class="lineno">19</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno">20</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_squares</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno">21</span> 
<span class="lineno">22</span>     <span class="k">def</span> <span class="nf">add_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic_id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="lineno">23</span>         <span class="n">topic</span> <span class="o">=</span> <span class="n">Topic</span><span class="p">(</span><span class="n">topic_id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="lineno">24</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="p">[</span><span class="n">topic_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">topic</span>
<span class="lineno">25</span>         <span class="c">#locate which square this topic should go</span>
<span class="lineno">26</span>         <span class="n">left_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">10</span>
<span class="lineno">27</span>         <span class="n">left_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">%</span> <span class="mi">10</span>
<span class="lineno">28</span>         <span class="n">square_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">left_x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span>
<span class="lineno">29</span>         <span class="n">square_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">left_y</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span>
<span class="lineno">30</span>         <span class="c">#check if this square exists</span>
<span class="lineno">31</span>         <span class="k">try</span><span class="p">:</span>
<span class="lineno">32</span>             <span class="n">square</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_squares</span><span class="p">[(</span><span class="n">square_x</span><span class="p">,</span> <span class="n">square_y</span><span class="p">)]</span>
<span class="lineno">33</span>         <span class="k">except</span><span class="p">:</span>
<span class="lineno">34</span>             <span class="n">square</span> <span class="o">=</span> <span class="n">Square</span><span class="p">(</span><span class="n">square_x</span><span class="p">,</span> <span class="n">square_y</span><span class="p">)</span>
<span class="lineno">35</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_squares</span><span class="p">[(</span><span class="n">square_x</span><span class="p">,</span> <span class="n">square_y</span><span class="p">)]</span> <span class="o">=</span> <span class="n">square</span>
<span class="lineno">36</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_ts</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="lineno">37</span>         <span class="n">square</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
<span class="lineno">38</span> 
<span class="lineno">39</span>     <span class="k">def</span> <span class="nf">_process_query_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbr_results</span><span class="p">,</span> <span class="n">list_squares</span><span class="p">):</span>
<span class="lineno">40</span>         <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">41</span>         <span class="n">go_on</span> <span class="o">=</span> <span class="bp">True</span>
<span class="lineno">42</span>         <span class="k">if</span> <span class="n">nbr_results</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span><span class="p">:</span>
<span class="lineno">43</span>             <span class="n">nbr_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span>
<span class="lineno">44</span>         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ts</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<span class="lineno">45</span>             <span class="n">temp_results</span><span class="p">,</span> <span class="n">nbr_results</span><span class="p">,</span> <span class="n">go_on</span> <span class="o">=</span> <span class="n">list_squares</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_topics</span><span class="p">(</span><span class="n">nbr_results</span><span class="p">)</span>
<span class="lineno">46</span>             <span class="n">results</span> <span class="o">+=</span> <span class="n">temp_results</span>
<span class="lineno">47</span>             <span class="k">if</span> <span class="ow">not</span> <span class="n">go_on</span><span class="p">:</span>
<span class="lineno">48</span>                 <span class="k">break</span>
<span class="lineno">49</span>         <span class="n">results</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="lineno">50</span>         <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
<span class="lineno">51</span> 
<span class="lineno">52</span>     <span class="k">def</span> <span class="nf">_process_query_question</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbr_results</span><span class="p">,</span> <span class="n">list_squares</span><span class="p">):</span>
<span class="lineno">53</span>         <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">54</span>         <span class="n">go_on</span> <span class="o">=</span> <span class="bp">True</span>
<span class="lineno">55</span>         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ts</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<span class="lineno">56</span>             <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">list_squares</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_topics</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
<span class="lineno">57</span>                 <span class="n">results</span><span class="p">,</span> <span class="n">nbr_results</span><span class="p">,</span> <span class="n">go_on</span> <span class="o">=</span> <span class="n">topic</span><span class="o">.</span><span class="n">get_questions</span><span class="p">(</span><span class="n">nbr_results</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
<span class="lineno">58</span>                 <span class="k">if</span> <span class="ow">not</span> <span class="n">go_on</span><span class="p">:</span>
<span class="lineno">59</span>                     <span class="k">break</span>
<span class="lineno">60</span>             <span class="k">if</span> <span class="ow">not</span> <span class="n">go_on</span><span class="p">:</span>
<span class="lineno">61</span>                 <span class="k">break</span>
<span class="lineno">62</span>         <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
<span class="lineno">63</span> 
<span class="lineno">64</span>     <span class="k">def</span> <span class="nf">process_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_type</span><span class="p">,</span> <span class="n">q_nbr_results</span><span class="p">,</span> <span class="n">q_x</span><span class="p">,</span> <span class="n">q_y</span><span class="p">):</span>
<span class="lineno">65</span>         <span class="n">list_squares</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">66</span>         <span class="k">for</span> <span class="n">square</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_squares</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
<span class="lineno">67</span>             <span class="n">square</span><span class="o">.</span><span class="n">set_current_distance</span><span class="p">(</span><span class="n">q_x</span><span class="p">,</span> <span class="n">q_y</span><span class="p">)</span>
<span class="lineno">68</span>             <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">list_squares</span><span class="p">,</span> <span class="n">square</span><span class="p">)</span>
<span class="lineno">69</span>         <span class="k">if</span> <span class="n">q_type</span> <span class="o">==</span> <span class="s">&quot;t&quot;</span><span class="p">:</span>
<span class="lineno">70</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_query_topic</span><span class="p">(</span><span class="n">q_nbr_results</span><span class="p">,</span> <span class="n">list_squares</span><span class="p">)</span>
<span class="lineno">71</span>         <span class="k">if</span> <span class="n">q_type</span> <span class="o">==</span> <span class="s">&quot;q&quot;</span><span class="p">:</span>
<span class="lineno">72</span>         	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_query_question</span><span class="p">(</span><span class="n">q_nbr_results</span><span class="p">,</span> <span class="n">list_squares</span><span class="p">)</span></code></pre></div>

<p>The complete solution:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">  1</span> <span class="c"># -*- coding: utf-8 -*-</span>
<span class="lineno">  2</span> <span class="sd">&#39;&#39;&#39;</span>
<span class="lineno">  3</span> <span class="sd">Created on Jan 09, 2013</span>
<span class="lineno">  4</span> 
<span class="lineno">  5</span> <span class="sd">@author: Mourad Mourafiq</span>
<span class="lineno">  6</span> 
<span class="lineno">  7</span> <span class="sd">About: This is an attempt to solve the Quora challenge Nearby.</span>
<span class="lineno">  8</span> <span class="sd">&#39;&#39;&#39;</span>
<span class="lineno">  9</span> <span class="kn">import</span> <span class="nn">math</span>
<span class="lineno"> 10</span> <span class="kn">import</span> <span class="nn">heapq</span>
<span class="lineno"> 11</span> 
<span class="lineno"> 12</span> <span class="n">THRESHOLD</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="lineno"> 13</span> <span class="n">SQUARE_SIDE</span> <span class="o">=</span> <span class="mi">10</span>
<span class="lineno"> 14</span> 
<span class="lineno"> 15</span> <span class="k">class</span> <span class="nc">Square</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 16</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 17</span> <span class="sd">    Square is data structure that represents a part of the plane.</span>
<span class="lineno"> 18</span> <span class="sd">    A square is divided to 4 parts.</span>
<span class="lineno"> 19</span> 
<span class="lineno"> 20</span> <span class="sd">    @type _origine_x: float</span>
<span class="lineno"> 21</span> <span class="sd">    @param _origine_x: the x coordinate of the origine of this square</span>
<span class="lineno"> 22</span> 
<span class="lineno"> 23</span> <span class="sd">    @type _origine_y: float</span>
<span class="lineno"> 24</span> <span class="sd">    @param _origine_y: the y coordinate of the origine of this square</span>
<span class="lineno"> 25</span> 
<span class="lineno"> 26</span> <span class="sd">    @type _curent_distance: int</span>
<span class="lineno"> 27</span> <span class="sd">    @param _curent_distance: current distance from the query coordiantes</span>
<span class="lineno"> 28</span> 
<span class="lineno"> 29</span> <span class="sd">    @type _tn: int</span>
<span class="lineno"> 30</span> <span class="sd">    @param _tn: numbre of points in this square  </span>
<span class="lineno"> 31</span> 
<span class="lineno"> 32</span> <span class="sd">    @type _topics: list</span>
<span class="lineno"> 33</span> <span class="sd">    @param _topics: list of topics</span>
<span class="lineno"> 34</span> <span class="sd">    &quot;&quot;&quot;</span>
<span class="lineno"> 35</span> 
<span class="lineno"> 36</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origine_x</span><span class="p">,</span> <span class="n">origine_y</span><span class="p">):</span>
<span class="lineno"> 37</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_origine_x</span> <span class="o">=</span> <span class="n">origine_x</span>
<span class="lineno"> 38</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_origine_y</span> <span class="o">=</span> <span class="n">origine_y</span>
<span class="lineno"> 39</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_current_distance</span> <span class="o">=</span> <span class="mi">0</span>
<span class="lineno"> 40</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span> <span class="o">=</span> <span class="mi">0</span>
<span class="lineno"> 41</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno"> 42</span> 
<span class="lineno"> 43</span>     <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">square</span><span class="p">):</span>
<span class="lineno"> 44</span>         <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_distance</span> <span class="o">-</span> <span class="n">square</span><span class="o">.</span><span class="n">_current_distance</span>
<span class="lineno"> 45</span>         <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno"> 46</span>             <span class="k">return</span> <span class="bp">True</span>
<span class="lineno"> 47</span>         <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno"> 48</span>             <span class="k">return</span> <span class="bp">False</span>
<span class="lineno"> 49</span> 
<span class="lineno"> 50</span>     <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">):</span>
<span class="lineno"> 51</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="lineno"> 52</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
<span class="lineno"> 53</span> 
<span class="lineno"> 54</span>     <span class="k">def</span> <span class="nf">set_current_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_x</span><span class="p">,</span> <span class="n">origin_y</span><span class="p">):</span>
<span class="lineno"> 55</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_current_distance</span> <span class="o">=</span> <span class="n">Topic</span><span class="o">.</span><span class="n">euclidean_dis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_origine_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_origine_y</span><span class="p">,</span> <span class="n">origin_x</span><span class="p">,</span> <span class="n">origin_y</span><span class="p">)</span>
<span class="lineno"> 56</span>         <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="p">:</span>
<span class="lineno"> 57</span>             <span class="n">topic</span><span class="o">.</span><span class="n">set_current_distance</span><span class="p">(</span><span class="n">origin_x</span><span class="p">,</span> <span class="n">origin_y</span><span class="p">)</span>
<span class="lineno"> 58</span> 
<span class="lineno"> 59</span>     <span class="k">def</span> <span class="nf">get_topics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tn</span><span class="p">):</span>
<span class="lineno"> 60</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span> <span class="o">&gt;=</span> <span class="n">tn</span><span class="p">:</span>
<span class="lineno"> 61</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="p">[:</span><span class="n">tn</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">False</span>
<span class="lineno"> 62</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno"> 63</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="p">,</span> <span class="n">tn</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_tn</span><span class="p">,</span> <span class="bp">True</span>
<span class="lineno"> 64</span> 
<span class="lineno"> 65</span> 
<span class="lineno"> 66</span> <span class="k">class</span> <span class="nc">Topic</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno"> 67</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 68</span> <span class="sd">    Topic</span>
<span class="lineno"> 69</span> 
<span class="lineno"> 70</span> <span class="sd">    @type _id: int</span>
<span class="lineno"> 71</span> <span class="sd">    @param _id: the id of the topic</span>
<span class="lineno"> 72</span> 
<span class="lineno"> 73</span> <span class="sd">    @type _x: float</span>
<span class="lineno"> 74</span> <span class="sd">    @param _x: the x coordinate in the plane</span>
<span class="lineno"> 75</span> 
<span class="lineno"> 76</span> <span class="sd">    @type _y: float</span>
<span class="lineno"> 77</span> <span class="sd">    @param _y: the y coordinate in the plane</span>
<span class="lineno"> 78</span> 
<span class="lineno"> 79</span> <span class="sd">    @type _current_distance: float</span>
<span class="lineno"> 80</span> <span class="sd">    @param _current_distance: the current distance from the origin(origin being the query coordiantaes)</span>
<span class="lineno"> 81</span> 
<span class="lineno"> 82</span> <span class="sd">    @type _qn: int</span>
<span class="lineno"> 83</span> <span class="sd">    @param _qn: the number of questions associated with this topics</span>
<span class="lineno"> 84</span> 
<span class="lineno"> 85</span> <span class="sd">    @type _questions: list</span>
<span class="lineno"> 86</span> <span class="sd">    @param _questions: the list of the questions associated with this topic</span>
<span class="lineno"> 87</span> <span class="sd">    &quot;&quot;&quot;</span>
<span class="lineno"> 88</span> 
<span class="lineno"> 89</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="lineno"> 90</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="nb">id</span>
<span class="lineno"> 91</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">x</span>
<span class="lineno"> 92</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y</span>
<span class="lineno"> 93</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_current_distance</span> <span class="o">=</span> <span class="mi">0</span>
<span class="lineno"> 94</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_qn</span> <span class="o">=</span> <span class="mi">0</span>
<span class="lineno"> 95</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_questions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno"> 96</span> 
<span class="lineno"> 97</span>     <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">):</span>
<span class="lineno"> 98</span>         <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_distance</span> <span class="o">-</span> <span class="n">topic</span><span class="o">.</span><span class="n">_current_distance</span>
<span class="lineno"> 99</span>         <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">THRESHOLD</span><span class="p">:</span>
<span class="lineno">100</span>             <span class="k">return</span> <span class="bp">True</span>
<span class="lineno">101</span>         <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="n">THRESHOLD</span><span class="p">:</span>
<span class="lineno">102</span>             <span class="k">return</span> <span class="bp">False</span>
<span class="lineno">103</span>         <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">&gt;</span> <span class="n">topic</span><span class="o">.</span><span class="n">_id</span> <span class="k">else</span> <span class="bp">False</span>
<span class="lineno">104</span> 
<span class="lineno">105</span>     <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">):</span>
<span class="lineno">106</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_qn</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="lineno">107</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_questions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
<span class="lineno">108</span> 
<span class="lineno">109</span>     <span class="k">def</span> <span class="nf">get_questions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qn</span><span class="p">,</span> <span class="n">questions</span><span class="p">):</span>
<span class="lineno">110</span>         <span class="n">go_on</span> <span class="o">=</span> <span class="bp">True</span>
<span class="lineno">111</span>         <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_questions</span><span class="p">:</span>
<span class="lineno">112</span>             <span class="k">if</span> <span class="n">question</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">questions</span><span class="p">:</span>
<span class="lineno">113</span>                 <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
<span class="lineno">114</span>                 <span class="n">qn</span> <span class="o">-=</span> <span class="mi">1</span>
<span class="lineno">115</span>                 <span class="k">if</span> <span class="n">qn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">116</span>                     <span class="n">go_on</span> <span class="o">=</span> <span class="bp">False</span>
<span class="lineno">117</span>                     <span class="k">break</span>
<span class="lineno">118</span>         <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">questions</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">qn</span><span class="p">,</span> <span class="n">go_on</span>
<span class="lineno">119</span> 
<span class="lineno">120</span>     <span class="k">def</span> <span class="nf">set_current_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin_x</span><span class="p">,</span> <span class="n">origin_y</span><span class="p">):</span>
<span class="lineno">121</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_current_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">euclidean_dis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">,</span> <span class="n">origin_x</span><span class="p">,</span> <span class="n">origin_y</span><span class="p">)</span>
<span class="lineno">122</span> 
<span class="lineno">123</span>     <span class="nd">@staticmethod</span>
<span class="lineno">124</span>     <span class="k">def</span> <span class="nf">euclidean_dis</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
<span class="lineno">125</span>         <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="lineno">126</span> 
<span class="lineno">127</span> 
<span class="lineno">128</span> <span class="k">class</span> <span class="nc">Nearby</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno">129</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno">130</span> <span class="sd">    Nearby solver</span>
<span class="lineno">131</span> 
<span class="lineno">132</span> <span class="sd">    @type _tn: int</span>
<span class="lineno">133</span> <span class="sd">    @param _tn: the number of topics created</span>
<span class="lineno">134</span> 
<span class="lineno">135</span> <span class="sd">    @type _topics: dict</span>
<span class="lineno">136</span> <span class="sd">    @param _topics: the dictionary of topics created  </span>
<span class="lineno">137</span> <span class="sd">    &quot;&quot;&quot;</span>
<span class="lineno">138</span> 
<span class="lineno">139</span> 
<span class="lineno">140</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tn</span><span class="p">):</span>
<span class="lineno">141</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span> <span class="o">=</span> <span class="n">tn</span>
<span class="lineno">142</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno">143</span> 
<span class="lineno">144</span>     <span class="k">def</span> <span class="nf">add_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic_id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="lineno">145</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="p">[</span><span class="n">topic_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">Topic</span><span class="p">(</span><span class="n">topic_id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="lineno">146</span> 
<span class="lineno">147</span>     <span class="k">def</span> <span class="nf">add_question</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">nbr_topics</span><span class="p">,</span> <span class="n">topics</span><span class="p">):</span>
<span class="lineno">148</span>         <span class="k">if</span> <span class="n">nbr_topics</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">149</span>             <span class="k">return</span>
<span class="lineno">150</span>         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">nbr_topics</span><span class="p">):</span>
<span class="lineno">151</span>             <span class="n">topic_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">topics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="lineno">152</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="p">[</span><span class="n">topic_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
<span class="lineno">153</span> 
<span class="lineno">154</span>     <span class="k">def</span> <span class="nf">_process_query_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbr_results</span><span class="p">,</span> <span class="n">list_topics</span><span class="p">):</span>
<span class="lineno">155</span>         <span class="k">if</span> <span class="n">nbr_results</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span><span class="p">:</span>
<span class="lineno">156</span>             <span class="n">nbr_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span>
<span class="lineno">157</span>         <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">list_topics</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">nbr_results</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
<span class="lineno">158</span> 
<span class="lineno">159</span>     <span class="k">def</span> <span class="nf">_process_query_question</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbr_results</span><span class="p">,</span> <span class="n">list_topics</span><span class="p">):</span>
<span class="lineno">160</span>         <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">161</span>         <span class="n">go_on</span> <span class="o">=</span> <span class="bp">True</span>
<span class="lineno">162</span>         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tn</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<span class="lineno">163</span>             <span class="n">results</span><span class="p">,</span> <span class="n">nbr_results</span><span class="p">,</span> <span class="n">go_on</span> <span class="o">=</span> <span class="n">list_topics</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_questions</span><span class="p">(</span><span class="n">nbr_results</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
<span class="lineno">164</span>             <span class="k">if</span> <span class="ow">not</span> <span class="n">go_on</span><span class="p">:</span>
<span class="lineno">165</span>                 <span class="k">break</span>
<span class="lineno">166</span>         <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
<span class="lineno">167</span> 
<span class="lineno">168</span>     <span class="k">def</span> <span class="nf">process_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_type</span><span class="p">,</span> <span class="n">q_nbr_results</span><span class="p">,</span> <span class="n">q_x</span><span class="p">,</span> <span class="n">q_y</span><span class="p">):</span>
<span class="lineno">169</span>         <span class="n">list_topics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">170</span>         <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
<span class="lineno">171</span>             <span class="n">topic</span><span class="o">.</span><span class="n">set_current_distance</span><span class="p">(</span><span class="n">q_x</span><span class="p">,</span> <span class="n">q_y</span><span class="p">)</span>
<span class="lineno">172</span>             <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">list_topics</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
<span class="lineno">173</span>         <span class="k">if</span> <span class="n">q_type</span> <span class="o">==</span> <span class="s">&quot;t&quot;</span><span class="p">:</span>
<span class="lineno">174</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_query_topic</span><span class="p">(</span><span class="n">q_nbr_results</span><span class="p">,</span> <span class="n">list_topics</span><span class="p">)</span>
<span class="lineno">175</span>         <span class="k">if</span> <span class="n">q_type</span> <span class="o">==</span> <span class="s">&quot;q&quot;</span><span class="p">:</span>
<span class="lineno">176</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_query_question</span><span class="p">(</span><span class="n">q_nbr_results</span><span class="p">,</span> <span class="n">list_topics</span><span class="p">)</span>
<span class="lineno">177</span> 
<span class="lineno">178</span> 
<span class="lineno">179</span> <span class="k">class</span> <span class="nc">NearbySquare</span><span class="p">(</span><span class="n">Nearby</span><span class="p">):</span>
<span class="lineno">180</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno">181</span> <span class="sd">    Nearby solver using the square data structure</span>
<span class="lineno">182</span> 
<span class="lineno">183</span> <span class="sd">    @type _tn: int</span>
<span class="lineno">184</span> <span class="sd">    @param _tn: the number of topics created</span>
<span class="lineno">185</span> 
<span class="lineno">186</span> <span class="sd">    @type _topics: dict</span>
<span class="lineno">187</span> <span class="sd">    @param _topics: the dictionary of topics created</span>
<span class="lineno">188</span> 
<span class="lineno">189</span> <span class="sd">    @type _squares: dict</span>
<span class="lineno">190</span> <span class="sd">    @param _squares: the dictionary of squares created  </span>
<span class="lineno">191</span> <span class="sd">    &quot;&quot;&quot;</span>
<span class="lineno">192</span> 
<span class="lineno">193</span> 
<span class="lineno">194</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tn</span><span class="p">):</span>
<span class="lineno">195</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span> <span class="o">=</span> <span class="n">tn</span>
<span class="lineno">196</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_ts</span> <span class="o">=</span> <span class="mi">0</span>
<span class="lineno">197</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno">198</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_squares</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno">199</span> 
<span class="lineno">200</span>     <span class="k">def</span> <span class="nf">add_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic_id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="lineno">201</span>         <span class="n">topic</span> <span class="o">=</span> <span class="n">Topic</span><span class="p">(</span><span class="n">topic_id</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="lineno">202</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_topics</span><span class="p">[</span><span class="n">topic_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">topic</span>
<span class="lineno">203</span>         <span class="c">#locate which square this topic should go</span>
<span class="lineno">204</span>         <span class="n">left_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">10</span>
<span class="lineno">205</span>         <span class="n">left_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">%</span> <span class="mi">10</span>
<span class="lineno">206</span>         <span class="n">square_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">left_x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span>
<span class="lineno">207</span>         <span class="n">square_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">left_y</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span>
<span class="lineno">208</span>         <span class="c">#check if this square exists</span>
<span class="lineno">209</span>         <span class="k">try</span><span class="p">:</span>
<span class="lineno">210</span>             <span class="n">square</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_squares</span><span class="p">[(</span><span class="n">square_x</span><span class="p">,</span> <span class="n">square_y</span><span class="p">)]</span>
<span class="lineno">211</span>         <span class="k">except</span><span class="p">:</span>
<span class="lineno">212</span>             <span class="n">square</span> <span class="o">=</span> <span class="n">Square</span><span class="p">(</span><span class="n">square_x</span><span class="p">,</span> <span class="n">square_y</span><span class="p">)</span>
<span class="lineno">213</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_squares</span><span class="p">[(</span><span class="n">square_x</span><span class="p">,</span> <span class="n">square_y</span><span class="p">)]</span> <span class="o">=</span> <span class="n">square</span>
<span class="lineno">214</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_ts</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="lineno">215</span>         <span class="n">square</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
<span class="lineno">216</span> 
<span class="lineno">217</span>     <span class="k">def</span> <span class="nf">_process_query_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbr_results</span><span class="p">,</span> <span class="n">list_squares</span><span class="p">):</span>
<span class="lineno">218</span>         <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">219</span>         <span class="n">go_on</span> <span class="o">=</span> <span class="bp">True</span>
<span class="lineno">220</span>         <span class="k">if</span> <span class="n">nbr_results</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span><span class="p">:</span>
<span class="lineno">221</span>             <span class="n">nbr_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tn</span>
<span class="lineno">222</span>         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ts</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<span class="lineno">223</span>             <span class="n">temp_results</span><span class="p">,</span> <span class="n">nbr_results</span><span class="p">,</span> <span class="n">go_on</span> <span class="o">=</span> <span class="n">list_squares</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_topics</span><span class="p">(</span><span class="n">nbr_results</span><span class="p">)</span>
<span class="lineno">224</span>             <span class="n">results</span> <span class="o">+=</span> <span class="n">temp_results</span>
<span class="lineno">225</span>             <span class="k">if</span> <span class="ow">not</span> <span class="n">go_on</span><span class="p">:</span>
<span class="lineno">226</span>                 <span class="k">break</span>
<span class="lineno">227</span>         <span class="n">results</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="lineno">228</span>         <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
<span class="lineno">229</span> 
<span class="lineno">230</span>     <span class="k">def</span> <span class="nf">_process_query_question</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbr_results</span><span class="p">,</span> <span class="n">list_squares</span><span class="p">):</span>
<span class="lineno">231</span>         <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">232</span>         <span class="n">go_on</span> <span class="o">=</span> <span class="bp">True</span>
<span class="lineno">233</span>         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ts</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<span class="lineno">234</span>             <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">list_squares</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_topics</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
<span class="lineno">235</span>                 <span class="n">results</span><span class="p">,</span> <span class="n">nbr_results</span><span class="p">,</span> <span class="n">go_on</span> <span class="o">=</span> <span class="n">topic</span><span class="o">.</span><span class="n">get_questions</span><span class="p">(</span><span class="n">nbr_results</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
<span class="lineno">236</span>                 <span class="k">if</span> <span class="ow">not</span> <span class="n">go_on</span><span class="p">:</span>
<span class="lineno">237</span>                     <span class="k">break</span>
<span class="lineno">238</span>             <span class="k">if</span> <span class="ow">not</span> <span class="n">go_on</span><span class="p">:</span>
<span class="lineno">239</span>                 <span class="k">break</span>
<span class="lineno">240</span>         <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
<span class="lineno">241</span> 
<span class="lineno">242</span>     <span class="k">def</span> <span class="nf">process_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_type</span><span class="p">,</span> <span class="n">q_nbr_results</span><span class="p">,</span> <span class="n">q_x</span><span class="p">,</span> <span class="n">q_y</span><span class="p">):</span>
<span class="lineno">243</span>         <span class="n">list_squares</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">244</span>         <span class="k">for</span> <span class="n">square</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_squares</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
<span class="lineno">245</span>             <span class="n">square</span><span class="o">.</span><span class="n">set_current_distance</span><span class="p">(</span><span class="n">q_x</span><span class="p">,</span> <span class="n">q_y</span><span class="p">)</span>
<span class="lineno">246</span>             <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">list_squares</span><span class="p">,</span> <span class="n">square</span><span class="p">)</span>
<span class="lineno">247</span>         <span class="k">if</span> <span class="n">q_type</span> <span class="o">==</span> <span class="s">&quot;t&quot;</span><span class="p">:</span>
<span class="lineno">248</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_query_topic</span><span class="p">(</span><span class="n">q_nbr_results</span><span class="p">,</span> <span class="n">list_squares</span><span class="p">)</span>
<span class="lineno">249</span>         <span class="k">if</span> <span class="n">q_type</span> <span class="o">==</span> <span class="s">&quot;q&quot;</span><span class="p">:</span>
<span class="lineno">250</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_query_question</span><span class="p">(</span><span class="n">q_nbr_results</span><span class="p">,</span> <span class="n">list_squares</span><span class="p">)</span>
<span class="lineno">251</span> 
<span class="lineno">252</span> 
<span class="lineno">253</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">raw_input</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
<span class="lineno">254</span> <span class="n">nearby</span> <span class="o">=</span> <span class="n">NearbySquare</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="lineno">255</span> <span class="k">while</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>  <span class="c">#list of topics</span>
<span class="lineno">256</span>     <span class="n">command</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="lineno">257</span>     <span class="n">nearby</span><span class="o">.</span><span class="n">add_topic</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<span class="lineno">258</span>     <span class="n">T</span> <span class="o">-=</span> <span class="mi">1</span>  
<span class="lineno">259</span> <span class="k">while</span><span class="p">(</span><span class="n">Q</span><span class="p">):</span>  <span class="c">#list of questions</span>
<span class="lineno">260</span>     <span class="n">command</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="lineno">261</span>     <span class="n">nearby</span><span class="o">.</span><span class="n">add_question</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">command</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
<span class="lineno">262</span>     <span class="n">Q</span> <span class="o">-=</span> <span class="mi">1</span>
<span class="lineno">263</span> <span class="k">while</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>  <span class="c">#process queries</span>
<span class="lineno">264</span>     <span class="n">command</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="lineno">265</span>     <span class="k">print</span> <span class="n">nearby</span><span class="o">.</span><span class="n">process_query</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
<span class="lineno">266</span>     <span class="n">N</span> <span class="o">-=</span> <span class="mi">1</span></code></pre></div>


            
<div class="social">
  
  <div class='twitter'>
    <a href="https://twitter.com/share" class="twitter-share-button"  data-text="Quora Nearby." data-related="mmourafiq">Tweet</a>
  </div>
  

  
  <div class='facebook'>
    <div class="fb-share-button" data-layout="button_count"></div>
  </div>
  

  
  <div class='google'>
    <div class="g-plusone" data-size="medium"></div>
  </div>
  
    
  
  <div class='hn'>
    <a href="https://news.ycombinator.com/submit" class="hn-button" data-title="Quora Nearby." data-url="http://mourafiq.com/2012/10/15/quora-nearby.html" data-count="horizontal">Vote on Hacker News</a>
  </div>
  

  
  <div class='reddit'>
    <a href="//www.reddit.com/submit" onclick="window.open('//www.reddit.com/submit?url=http://mourafiq.com/2012/10/15/quora-nearby.html&title=Quora+Nearby.'); return false"> <img src="//www.redditstatic.com/spreddit7.gif" alt="submit to reddit" border="0" /> </a>
  </div>
  
</div>

        </section>

        <footer>
            <address>
                <img src="/images/logo.png">
                <p>
                Written by <strong><a rel="author" href="https://twitter.com/mmourafiq" title="Mourad Mourafiq." target="_blank">Mourad Mourafiq.</a></strong><br>
                    <span class="muted">Maths, Technology, Philosophy, Startups, ...</span>
                </p>
            </address>
            
            
            <section class="post_summary">
                <h3 class="title">Next up: <a href="/2012/11/01/quora-type-ahead.html" rel="prefetch">Quora Typeahead search.</a></h3>
                <p>Designing an algorithm to return the most relevant results that match the search query entered into the input text field.</p>
                <hr>
            </section>
             
            
            
            <section class="post_summary">
                <h3 class="title">Previous story: <a href="/2012/10/01/quora-feed-optimizer.html" rel="prefetch">Quora Feed Optimizer.</a></h3>
                <p>Designing an algorithm that picks the stories to display in the feed.</p>
                <hr>
            </section>
             
            
            <section>
                <div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'mourafiq';

  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
            </section>
            
        </footer>
    </div>
</article>


    <footer class="site-footer">
        <div class="container">
            &copy; 2018 Mourad Mourafiq

            <nav>
                <a href="/">Blog</a> &middot;
                <a href="/about.html">About</a>
            </nav>

            <nav class="social">
                
<a href="https://twitter.com/mmourafiq" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter"></i></a>


<a href="https://github.com/mouradmourafiq" title="Watch on Github" target="_blank"><i class="icon icon-github"></i></a>


<a href="/atom.xml" title="RSS Feed">
  <i class="icon icon-rss"></i>
</a>

            </nav>
            <div>Based on Incorporated theme by <a href="https://sendtoinc.com">Inc</a></div>
        </div>
    </footer>

</body>
</html>
