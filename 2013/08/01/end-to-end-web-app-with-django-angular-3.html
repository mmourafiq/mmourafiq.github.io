<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End to end web app with Django-Rest-Framework & AngularJS. &mdash; Mourad Mourafiq</title>
    <!--[if lt IE 9]><script src='https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js'></script><![endif]-->
    
    <link rel="stylesheet" href="/assets/app.css">
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<script src="/assets/app.js"></script>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>

<script>
  var HN=[];HN.factory=function(e){return function(){HN.push([e].concat(Array.prototype.slice.call(arguments,0)))};},HN.on=HN.factory("on"),HN.once=HN.factory("once"),HN.off=HN.factory("off"),HN.emit=HN.factory("emit"),HN.load=function(){var e="hn-button.js";if(document.getElementById(e))return;var t=document.createElement("script");t.id=e,t.src="//hn-button.herokuapp.com/hn-button.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n)},HN.load();</script>
</script>


aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-34892053-1', 'auto');
  ga('send', 'pageview');
</script>



    <link rel="shortcut icon" href="/favicon.ico?v2" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Mourad Mourafiq" href="/atom.xml" />
    <meta name="title" content="End to end web app with Django-Rest-Framework & AngularJS. ">
    <link rel="canonical" href="http://mourafiq.com/2013/08/01/end-to-end-web-app-with-django-angular-3.html">
     
           
    <meta property="og:title" content="End to end web app with Django-Rest-Framework & AngularJS."/>
    <meta property="og:url" content="http://mourafiq.com/2013/08/01/end-to-end-web-app-with-django-angular-3.html"/>
    <meta property="og:image" content="http://mourafiq.com/images/posts/django+angular.png"/>
    
    <meta property="og:description" content="[Part 3]."/>
    <meta name="description" content="[Part 3]."/>
    
    <meta property="og:site_name" content="Mourad Mourafiq">
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</head>
<body>

    <header class="site-header">
        <nav>
            <a class="brand" href="/">
                <img src="/images/logo.png" alt="Inc">
            </a>
            <a href="/about.html">About</a>
        </nav>
    </header>

    
<div class="cover  article-cover " style="background-image:url(/images/posts/django+angular.png)"></div>


<div class='cover-caption'><a href='/about.html#pictures'>django+angular</a></div>


<article >
    <div class="container">
        <header>
            
            <div class="meta">
                <!--
                By
                <address><a rel="author" href="" title="Mourad Mourafiq." target="_blank">
                    Mourad Mourafiq.
                </a></address> &mdash;
                -->
                <time pubdate datetime="2013-01-August" title="Aug 01, 2013">
                    Aug 01, 2013
                </time> &mdash;
                
6 min read
            </div>
            
            <h1 class="title">End to end web app with Django-Rest-Framework & AngularJS.</h1>
            <h2 class="subtitle">[Part 3].</h2>
        </header>

        <section>
            <p>In the 2 previous posts we built a backend API with DRF and a client with AngularJs.</p>

<p>In this part, we will add authentication and permission to our app. We will add some restrictions on who can edit and delete posts.</p>

<ul>
  <li>Authenticated users can create blog posts</li>
  <li>Posts are tied to their author (edit/delete permissions)</li>
  <li>Posts are read only for unauthenticated users</li>
</ul>

<p>Since we are going to make some changes in our models, we need to install south. Update the environment</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">&gt;</span>  git checkout part3
<span class="gp">&gt;</span>  pip install -r requirements.pip</code></pre></div>

<p>And add south to the installed apps.</p>

<p>N.B. Because we are updating tables that are already in the db the initial schemamigration won’t work instead we use:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">&gt;</span>  ./blog/manage.py  convert_to_south posts</code></pre></div>

<p>this gets it in the right state for further alterations.</p>

<p>Let’s add a field to represent the author of this post.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;auth.User&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;posts&#39;</span><span class="p">)</span></code></pre></div>

<p>All we need to do now is to go back and run :</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">&gt;</span>  ./blog/manage.py schemamigration posts --auto
<span class="gp">&gt;</span>  ./blog/manage.py migrate posts</code></pre></div>

<p>You will be asked to specify a default value. enter 1 (the id of the first user by default)</p>

<h3 id="associating-posts-with-users">Associating Posts with Users</h3>

<p>Right now, if a user created a post, there’d be no way of associating the user that created the post, with the post instance. The user isn’t sent as part of the serialized representation, but is instead a property of the incoming request.</p>

<p>The way we deal with that is by overriding a .pre_save() method on our posts views, that allows us to handle any information that is implicit in the incoming request or requested URL.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">pre_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="lineno">2</span>     <span class="n">obj</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span></code></pre></div>

<h3 id="updating-our-serializer">Updating our serializer</h3>

<p>Now that posts are associated with the author that created them, let’s update our PostSerializer to reflect that. Add the following field to the serializer definition:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>
<span class="lineno"> 2</span> <span class="kn">from</span> <span class="nn">posts.models</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="k">class</span> <span class="nc">PostSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedModelSerializer</span><span class="p">):</span>
<span class="lineno"> 6</span>     <span class="n">author</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&#39;author.username&#39;</span><span class="p">)</span>
<span class="lineno"> 7</span>     <span class="n">api_url</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">SerializerMethodField</span><span class="p">(</span><span class="s">&#39;get_api_url&#39;</span><span class="p">)</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span>     <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
<span class="lineno">10</span>         <span class="n">model</span> <span class="o">=</span> <span class="n">Post</span>
<span class="lineno">11</span>         <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;description&#39;</span><span class="p">,</span> <span class="s">&#39;created_on&#39;</span><span class="p">,</span> <span class="s">&#39;author&#39;</span><span class="p">,</span> <span class="s">&#39;url&#39;</span><span class="p">,</span> <span class="s">&#39;api_url&#39;</span><span class="p">)</span>
<span class="lineno">12</span>         <span class="n">read_only_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;created_on&#39;</span><span class="p">)</span>
<span class="lineno">13</span> 
<span class="lineno">14</span>     <span class="k">def</span> <span class="nf">get_api_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="lineno">15</span>         <span class="k">return</span> <span class="s">&quot;#/post/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="o">.</span><span class="n">id</span></code></pre></div>

<h3 id="adding-required-permissions-to-views">Adding required permissions to views</h3>

<p>Now that code posts are associated with users, we want to make sure that only authenticated users are able to create, update and delete posts.</p>

<p>REST framework includes a number of permission classes that we can use to restrict who can access a given view. In this case the one we’re looking for is IsAuthenticatedOrReadOnly, which will ensure that authenticated requests get read-write access, and unauthenticated requests get read-only access.</p>

<p>We’d also like all posts to be visible to anyone, but make sure that only the author is able to update or delete it.</p>

<p>To do that we’re going to need to create a custom permission.</p>

<p>In the posts app, create a new file, <code>permissions.py</code></p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">permissions</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="k">class</span> <span class="nc">IsOwnerOrReadOnly</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
<span class="lineno"> 4</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno"> 5</span> <span class="sd">    Custom permission to only allow owners of an object to edit it.</span>
<span class="lineno"> 6</span> <span class="sd">    &quot;&quot;&quot;</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span>     <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="lineno"> 9</span>         <span class="c"># Read permissions are allowed to any request</span>
<span class="lineno">10</span>         <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">permissions</span><span class="o">.</span><span class="n">SAFE_METHODS</span><span class="p">:</span>
<span class="lineno">11</span>             <span class="k">return</span> <span class="bp">True</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>         <span class="c"># Write permissions are only allowed to the owner of the tip</span>
<span class="lineno">14</span>         <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span></code></pre></div>

<h3 id="setting-authentication">Setting authentication</h3>

<p>The default authentication schemes may be set globally, using the <code>DEFAULT_AUTHENTICATION</code> setting. For example.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno">2</span>     <span class="s">&#39;DEFAULT_AUTHENTICATION_CLASSES&#39;</span><span class="p">:</span> <span class="p">(</span>
<span class="lineno">3</span>            <span class="s">&#39;rest_framework.authentication.SessionAuthentication&#39;</span><span class="p">,</span>
<span class="lineno">4</span>     <span class="p">)</span>
<span class="lineno">5</span> <span class="p">}</span></code></pre></div>

<p>We will make use of the DRF auth-api to authenticate our users. Add a pattern to include the login and logout in the browsable API.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
<span class="lineno">2</span>     <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^api-auth/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">&#39;rest_framework.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s">&#39;rest_framework&#39;</span><span class="p">)),</span>
<span class="lineno">3</span> <span class="p">)</span></code></pre></div>

<p>Finally we need to add some conditions in our templates, for both feeds and post view, to check if the user is authenticated or not. For this purpose, we are going to use the GlobalService that we initialize when loading the landing page of our app.</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="lineno">1</span> <span class="nt">&lt;body</span> <span class="na">data-spy=</span><span class="s">&quot;scroll&quot;</span> <span class="na">id=</span><span class="s">&quot;index&quot;</span> <span class="na">style=</span><span class="s">&quot;zoom: 1;&quot;</span> <span class="na">ng-controller=</span><span class="s">&quot;AppController&quot;</span> <span class="na">ng-init=</span><span class="s">&quot;initialize(&#39;&#39;)&quot;</span><span class="nt">&gt;</span></code></pre></div>

<p>And to use this global variable we can do something like this</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="lineno">1</span> <span class="nt">&lt;a</span> <span class="na">ng-show=</span><span class="s">&quot;globals.is_authenticated&quot;</span> <span class="na">class=</span><span class="s">&quot;btn&quot;</span> <span class="na">ng-click=</span><span class="s">&quot;open(&#39;create&#39;)&quot;</span><span class="nt">&gt;</span> Create<span class="nt">&lt;/a&gt;</span>
<span class="lineno">2</span> <span class="nt">&lt;a</span> <span class="na">ng-hide=</span><span class="s">&quot;globals.is_authenticated&quot;</span> <span class="na">class=</span><span class="s">&quot;btn&quot;</span> <span class="na">href=</span><span class="s">&quot;/api-auth/login/&quot;</span><span class="nt">&gt;</span> Create<span class="nt">&lt;/a&gt;</span></code></pre></div>

<p>Also we update our templates to include the author informations</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="lineno">1</span> <span class="nt">&lt;small&gt;&lt;b&gt;</span>by<span class="nt">&lt;/b&gt;</span> {[{post.author}]}<span class="nt">&lt;/small&gt;</span></code></pre></div>


            
<div class="social">
  
  <div class='twitter'>
    <a href="https://twitter.com/share" class="twitter-share-button"  data-text="End to end web app with Django-Rest-Framework & AngularJS." data-related="mmourafiq">Tweet</a>
  </div>
  

  
  <div class='facebook'>
    <div class="fb-share-button" data-layout="button_count"></div>
  </div>
  

  
  <div class='google'>
    <div class="g-plusone" data-size="medium"></div>
  </div>
  
    
  
  <div class='hn'>
    <a href="https://news.ycombinator.com/submit" class="hn-button" data-title="End to end web app with Django-Rest-Framework & AngularJS." data-url="http://mourafiq.com/2013/08/01/end-to-end-web-app-with-django-angular-3.html" data-count="horizontal">Vote on Hacker News</a>
  </div>
  

  
  <div class='reddit'>
    <a href="//www.reddit.com/submit" onclick="window.open('//www.reddit.com/submit?url=http://mourafiq.com/2013/08/01/end-to-end-web-app-with-django-angular-3.html&title=End+to+end+web+app+with+Django-Rest-Framework+%26+AngularJS.'); return false"> <img src="//www.redditstatic.com/spreddit7.gif" alt="submit to reddit" border="0" /> </a>
  </div>
  
</div>

        </section>

        <footer>
            <address>
                <img src="/images/logo.png">
                <p>
                Written by <strong><a rel="author" href="https://twitter.com/mmourafiq" title="Mourad Mourafiq." target="_blank">Mourad Mourafiq.</a></strong><br>
                    <span class="muted">Maths, Technology, Philosophy, Startups, ...</span>
                </p>
            </address>
            
            
            <section class="post_summary">
                <h3 class="title">Next up: <a href="/2013/08/15/end-to-end-web-app-with-django-angular-4.html" rel="prefetch">End to end web app with Django-Rest-Framework & AngularJS.</a></h3>
                <p>[Part 4].</p>
                <hr>
            </section>
             
            
            
            <section class="post_summary">
                <h3 class="title">Previous story: <a href="/2013/07/15/end-to-end-web-app-with-django-angular-2.html" rel="prefetch">End to end web app with Django-Rest-Framework & AngularJS.</a></h3>
                <p>[Part 2].</p>
                <hr>
            </section>
             
            
            <section>
                <div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'mourafiq';

  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
            </section>
            
        </footer>
    </div>
</article>


    <footer class="site-footer">
        <div class="container">
            &copy; 2016 Mourad Mourafiq

            <nav>
                <a href="/">Blog</a> &middot;
                <a href="/about.html">About</a>
            </nav>

            <nav class="social">
                
<a href="https://twitter.com/mmourafiq" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter"></i></a>


<a href="https://github.com/mouradmourafiq" title="Watch on Github" target="_blank"><i class="icon icon-github"></i></a>


<a href="/atom.xml" title="RSS Feed">
  <i class="icon icon-rss"></i>
</a>

            </nav>
            <div>Based on Incorporated theme by <a href="https://sendtoinc.com">Inc</a></div>
        </div>
    </footer>

</body>
</html>
