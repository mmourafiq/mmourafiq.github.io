<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playing with convolutions in TensorFlow &mdash; Mourad Mourafiq</title>
    <!--[if lt IE 9]><script src='https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js'></script><![endif]-->
    
    <link rel="stylesheet" href="/assets/app.css">
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<script src="/assets/app.js"></script>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>

<script>
  var HN=[];HN.factory=function(e){return function(){HN.push([e].concat(Array.prototype.slice.call(arguments,0)))};},HN.on=HN.factory("on"),HN.once=HN.factory("once"),HN.off=HN.factory("off"),HN.emit=HN.factory("emit"),HN.load=function(){var e="hn-button.js";if(document.getElementById(e))return;var t=document.createElement("script");t.id=e,t.src="//hn-button.herokuapp.com/hn-button.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n)},HN.load();</script>
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-34892053-1', 'auto');
  ga('send', 'pageview');
</script>



    <link rel="shortcut icon" href="/favicon.ico?v2" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Mourad Mourafiq" href="/atom.xml" />
    <meta name="title" content="Playing with convolutions in TensorFlow ">
    <link rel="canonical" href="http://mourafiq.com/2016/08/10/playing-with-convolutions-in-tensorflow.html">
     
           
    <meta property="og:title" content="Playing with convolutions in TensorFlow"/>
    <meta property="og:url" content="http://mourafiq.com/2016/08/10/playing-with-convolutions-in-tensorflow.html"/>
    <meta property="og:image" content="http://mourafiq.com/images/posts/tensorflow.jpg"/>
    
    <meta property="og:description" content="From a short introduction of convolutions to a complete model."/>
    <meta name="description" content="From a short introduction of convolutions to a complete model."/>
    
    <meta property="og:site_name" content="Mourad Mourafiq">
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</head>
<body>

    <header class="site-header">
        <nav>
            <a class="brand" href="/">
                <img src="/images/logo.png" alt="Inc">
            </a>
            <a href="/about.html">About</a>
        </nav>
    </header>

    
<div class="cover  article-cover " style="background-image:url(/images/posts/tensorflow.jpg)"></div>


<div class='cover-caption'><a href='/about.html#pictures'></a></div>


<article >
    <div class="container">
        <header>
            
            <div class="meta">
                <!--
                By
                <address><a rel="author" href="" title="Mourad Mourafiq." target="_blank">
                    Mourad Mourafiq.
                </a></address> &mdash;
                -->
                <time pubdate datetime="2016-10-August" title="Aug 10, 2016">
                    Aug 10, 2016
                </time> &mdash;
                
19 min read
            </div>
            
            <h1 class="title">Playing with convolutions in TensorFlow</h1>
            <h2 class="subtitle">From a short introduction of convolutions to a complete model.</h2>
        </header>

        <section>
            <p>In this post we will try to develop a practical intuition about convolutions and visualize different steps used in convolutional neural network architectures. The code used for this tutorial can be found <a href="https://github.com/mouradmourafiq/tensorflow-convolution-models">here</a>.</p>

<p>This tutorial does not cover back propagation, sparse connectivity, shared weights and other theoritical aspects that are already covered in other courses and tutorials. Instead it focuses on giving a practical intuition on how to use tensorflow to build a convolutional model.</p>

<ul>
  <li>So what are convoltions?</li>
</ul>

<p>Convolution is a mathematical operation between two functions producing a third convoluted function that is a modefied version of the first function. In the case of image processing, it’s the process of multiplying each element of matrix with its local neighbors, weighted by the kernel (or filter). For example, given a maxtrix <script type="math/tex">M</script> and kernel <script type="math/tex">c</script> as follow:</p>

<script type="math/tex; mode=display">% <![CDATA[
M =
\left( \begin{array}{ccccc}
m_{00} & m_{01} & m_{02} & m_{03} & m_{04} \\
m_{10} & m_{11} & m_{12} & m_{13} & m_{14} \\
m_{20} & m_{21} & m_{22} & m_{23} & m_{24} \\
m_{30} & m_{31} & m_{32} & m_{33} & m_{34} \\
m_{40} & m_{41} & m_{42} & m_{43} & m_{44}
\end{array}\right) %]]></script>

<p>and</p>

<script type="math/tex; mode=display">% <![CDATA[
c =
\left( \begin{array}{ccc}
c_{00} & c_{01} & c_{02} \\
c_{10} & c_{11} & c_{12} \\
c_{20} & c_{21} & c_{22}
\end{array}\right) %]]></script>

<p>The discrete convolution operation is defined as</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{aligned}
conv(M, c)[1, 1] = & m_{11} * c_{00} + m_{12} * c_{01} + m_{13} * c_{02} + \\
               & m_{21} * c_{10} + m_{22} * c_{11} + m_{23} * c_{12} + \\
               & m_{31} * c_{20} + m_{32} * c_{21} + m_{33} * c_{22}
\end{aligned} %]]></script>

<p>To visualize how convolution slides to calculate the output matrix, it’s good to look at a vizualization:</p>

<p><img src="/images/posts/convolution_schematic.gif" alt="Convolution with 3×3 Filter" />
Source: http://deeplearning.stanford.edu/wiki/index.php/Feature_extraction_using_convolution</p>

<p>In convolutional architectures it’s also common to use pooling layer after each convolution, these pooling layers generally simplify the information of the convolution layer before, by choosing the most prominent value (max pooling) or averaging the values calculated in by the convolution (average pooling).</p>

<p><img src="/images/posts/pooling_schematic.gif" alt="Pooling" />
Source: http://deeplearning.stanford.edu/wiki/index.php/File:Pooling_schematic.gif</p>

<ul>
  <li>Computing convolutions and pooling:</li>
</ul>

<p>First of all let’s prepare the environment:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="lineno">2</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="lineno">3</span> <span class="kn">import</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">as</span> <span class="nn">gridspec</span>
<span class="lineno">4</span> 
<span class="lineno">5</span> <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="lineno">6</span> <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="lineno">7</span> <span class="kn">import</span> <span class="nn">numpy</span></code></pre></div>

<p>We need also a picture to play with</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;gray_kitten.jpg&#39;</span><span class="p">)</span>
<span class="lineno">2</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span></code></pre></div>

<p><img src="/images/posts/gray_kitten.jpg" alt="Gray kitten" /></p>

<p>And in order to visualize the result of each operation, we need to write some utils functions</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">def</span> <span class="nf">show_image_ops_gray</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">conv_op</span><span class="p">,</span> <span class="n">sigmoid_op</span><span class="p">,</span> <span class="n">avg_pool_op</span><span class="p">,</span> <span class="n">max_pool_op</span><span class="p">):</span>
<span class="lineno"> 2</span>     <span class="n">gs1</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="lineno"> 3</span>     <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;gray&#39;</span><span class="p">))</span>
<span class="lineno"> 4</span>     <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">conv_op</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;gray&#39;</span><span class="p">))</span>
<span class="lineno"> 5</span>     <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sigmoid_op</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;gray&#39;</span><span class="p">))</span>
<span class="lineno"> 6</span>     <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">avg_pool_op</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;gray&#39;</span><span class="p">))</span>
<span class="lineno"> 7</span>     <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">max_pool_op</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;gray&#39;</span><span class="p">))</span>
<span class="lineno"> 8</span>     <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="k">def</span> <span class="nf">show_image_ops_rgb</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">conv_op</span><span class="p">,</span> <span class="n">sigmoid_op</span><span class="p">,</span> <span class="n">avg_pool_op</span><span class="p">,</span> <span class="n">max_pool_op</span><span class="p">):</span>
<span class="lineno">12</span>     <span class="n">gs1</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="lineno">13</span>     <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:])</span>
<span class="lineno">14</span>     <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">conv_op</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span>
<span class="lineno">15</span>     <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sigmoid_op</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span>
<span class="lineno">16</span>     <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">avg_pool_op</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span>
<span class="lineno">17</span>     <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">max_pool_op</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span>
<span class="lineno">18</span>     <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="lineno">19</span> 
<span class="lineno">20</span> <span class="k">def</span> <span class="nf">show_shapes</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">conv_op</span><span class="p">,</span> <span class="n">sigmoid_op</span><span class="p">,</span> <span class="n">avg_pool_op</span><span class="p">,</span> <span class="n">max_pool_op</span><span class="p">):</span>
<span class="lineno">21</span>     <span class="k">print</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="lineno">22</span> <span class="s">        image filters (shape {})</span>
<span class="lineno">23</span> <span class="s">        conv_op filters (shape {})</span>
<span class="lineno">24</span> <span class="s">        sigmoid_op filters (shape {})</span>
<span class="lineno">25</span> <span class="s">        avg_pool_op filters (shape {})</span>
<span class="lineno">26</span> <span class="s">        max_pool_op filters (shape {})</span>
<span class="lineno">27</span> <span class="s">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="lineno">28</span>             <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">conv_op</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">sigmoid_op</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">avg_pool_op</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">max_pool_op</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span></code></pre></div>

<p>Now that we have a way to visualize every step, let’s create the tensorflow operations</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">def</span> <span class="nf">convolve</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pooling</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s">&#39;SAME&#39;</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
<span class="lineno"> 2</span>     <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
<span class="lineno"> 3</span>         <span class="n">num_maps</span> <span class="o">=</span> <span class="mi">3</span>
<span class="lineno"> 4</span>         <span class="k">if</span> <span class="ow">not</span> <span class="n">rgb</span><span class="p">:</span>
<span class="lineno"> 5</span>             <span class="n">num_maps</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c"># set number of maps to 1</span>
<span class="lineno"> 6</span>             <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s">&#39;L&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.2989</span><span class="p">,</span> <span class="mf">0.5870</span><span class="p">,</span> <span class="mf">0.1140</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>  <span class="c"># convert to gray scale</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span>         <span class="c"># reshape image to have a leading 1 dimension</span>
<span class="lineno">10</span>         <span class="n">img</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;float32&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">256.</span>
<span class="lineno">11</span>         <span class="n">img_shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
<span class="lineno">12</span>         <span class="n">img_reshaped</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">img_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">num_maps</span><span class="p">)</span>
<span class="lineno">13</span> 
<span class="lineno">14</span>         <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="s">&#39;float32&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">num_maps</span><span class="p">])</span>
<span class="lineno">15</span>         <span class="n">w</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">kernel</span><span class="p">))</span>
<span class="lineno">16</span> 
<span class="lineno">17</span>         <span class="c"># operations</span>
<span class="lineno">18</span>         <span class="n">conv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>
<span class="lineno">19</span>         <span class="n">sig</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
<span class="lineno">20</span>         <span class="n">max_pool</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">max_pool</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>
<span class="lineno">21</span>         <span class="n">avg_pool</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">avg_pool</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>
<span class="lineno">22</span> 
<span class="lineno">23</span>         <span class="n">init</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">initialize_all_variables</span><span class="p">()</span>
<span class="lineno">24</span>         <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="lineno">25</span>             <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>
<span class="lineno">26</span>             <span class="n">conv_op</span><span class="p">,</span> <span class="n">sigmoid_op</span><span class="p">,</span> <span class="n">avg_pool_op</span><span class="p">,</span> <span class="n">max_pool_op</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">conv</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">avg_pool</span><span class="p">,</span> <span class="n">max_pool</span><span class="p">],</span>
<span class="lineno">27</span>                                                                         <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">img_reshaped</span><span class="p">})</span>
<span class="lineno">28</span> 
<span class="lineno">29</span>         <span class="n">show_shapes</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">conv_op</span><span class="p">,</span> <span class="n">sigmoid_op</span><span class="p">,</span> <span class="n">avg_pool_op</span><span class="p">,</span> <span class="n">max_pool_op</span><span class="p">)</span>
<span class="lineno">30</span>         <span class="k">if</span> <span class="n">rgb</span><span class="p">:</span>
<span class="lineno">31</span>             <span class="n">show_image_ops_rgb</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">conv_op</span><span class="p">,</span> <span class="n">sigmoid_op</span><span class="p">,</span> <span class="n">avg_pool_op</span><span class="p">,</span> <span class="n">max_pool_op</span><span class="p">)</span>
<span class="lineno">32</span>         <span class="k">else</span><span class="p">:</span>
<span class="lineno">33</span>             <span class="n">show_image_ops_gray</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">conv_op</span><span class="p">,</span> <span class="n">sigmoid_op</span><span class="p">,</span> <span class="n">avg_pool_op</span><span class="p">,</span> <span class="n">max_pool_op</span><span class="p">)</span></code></pre></div>

<p>The convolve function that we have will allow us to try any filter from the <a href="https://docs.gimp.org/en/plug-in-convmatrix.html">gimp’s documentation</a>, we will try some of them here, but you can modify the kernels to see how image changes.</p>

<ul>
  <li>sharpen filter</li>
</ul>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="lineno">2</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="lineno">3</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="lineno">4</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="lineno">5</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="lineno">6</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="lineno">7</span> <span class="n">convolve</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></code></pre></div>

<p>This gives the following results</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">image</span> <span class="n">filters</span> <span class="p">(</span><span class="n">shape</span> <span class="p">(</span><span class="mi">134</span><span class="p">,</span> <span class="mi">240</span><span class="p">))</span>
<span class="n">conv_op</span> <span class="n">filters</span> <span class="p">(</span><span class="n">shape</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">sigmoid_op</span> <span class="n">filters</span> <span class="p">(</span><span class="n">shape</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">avg_pool_op</span> <span class="n">filters</span> <span class="p">(</span><span class="n">shape</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">max_pool_op</span> <span class="n">filters</span> <span class="p">(</span><span class="n">shape</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></code></pre></div>

<p><img src="/images/posts/sharpen_filter_gray.png" alt="sharpen_filter" /></p>

<ul>
  <li>blure filter</li>
</ul>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="lineno"> 2</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="lineno"> 3</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.125</span>
<span class="lineno"> 4</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.125</span>
<span class="lineno"> 5</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.125</span>
<span class="lineno"> 6</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.125</span>
<span class="lineno"> 7</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0625</span>
<span class="lineno"> 8</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0625</span>
<span class="lineno"> 9</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0625</span>
<span class="lineno">10</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0625</span>
<span class="lineno">11</span> <span class="n">convolve</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">rgb</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></code></pre></div>

<p>This gives the following results</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">image</span> <span class="n">filters</span> <span class="p">(</span><span class="n">shape</span> <span class="p">(</span><span class="mi">134</span><span class="p">,</span> <span class="mi">240</span><span class="p">))</span>
<span class="n">conv_op</span> <span class="n">filters</span> <span class="p">(</span><span class="n">shape</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">sigmoid_op</span> <span class="n">filters</span> <span class="p">(</span><span class="n">shape</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">avg_pool_op</span> <span class="n">filters</span> <span class="p">(</span><span class="n">shape</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">max_pool_op</span> <span class="n">filters</span> <span class="p">(</span><span class="n">shape</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></code></pre></div>

<p><img src="/images/posts/blure_filter_gray.png" alt="blure_filter" /></p>

<ul>
  <li>Convolutional model</li>
</ul>

<p>After trying the filters in the example and changing the values to see how they change the original image, we not only start to  develop an intuition about how these operations work, but we can also used them to create a convolutional neural network.</p>

<p>CNNs are basically just multiple layers of convolutions with nonlinear activation functions, e.g sigmoid, relu or tanh applied to the results, Followed with either other convolutions layers or pooling layers and finally fully connected layers. In this section we will be using the high-level machine learning API <code>tf.contrib.learn</code>, <code>tf.contrib.layers</code> and <code>tf.contrib.layers</code> to create, train and configure our models.</p>

<ul>
  <li>LeNet model</li>
</ul>

<p>LeNet model contains the essence of CNNs that are still used in larger and newer models. LeNet consists of 2 convolutional layers followed by a dense layer.</p>

<p>A convolution layer in LeNet model consists of a convolution operation followed by a max pooling operation:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">lenet_layer</span><span class="p">(</span><span class="n">tensor_in</span><span class="p">,</span> <span class="n">n_filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">tanh</span><span class="p">,</span>
<span class="lineno">2</span>                 <span class="n">padding</span><span class="o">=</span><span class="s">&#39;SAME&#39;</span><span class="p">):</span>
<span class="lineno">3</span>     <span class="n">conv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">convolution2d</span><span class="p">(</span><span class="n">tensor_in</span><span class="p">,</span>
<span class="lineno">4</span>                                            <span class="n">num_outputs</span><span class="o">=</span><span class="n">n_filters</span><span class="p">,</span>
<span class="lineno">5</span>                                            <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
<span class="lineno">6</span>                                            <span class="n">activation_fn</span><span class="o">=</span><span class="n">activation_fn</span><span class="p">,</span>
<span class="lineno">7</span>                                            <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>
<span class="lineno">8</span>     <span class="n">pool</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">max_pool</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="n">pool_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">pool_size</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>
<span class="lineno">9</span>     <span class="k">return</span> <span class="n">pool</span></code></pre></div>

<p>We need also to define our fully connected layer which could have some dropout:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">def</span> <span class="nf">dense_layer</span><span class="p">(</span><span class="n">tensor_in</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">tanh</span><span class="p">,</span> <span class="n">keep_prob</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="lineno"> 2</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_prob</span><span class="p">:</span>
<span class="lineno"> 3</span>         <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
<span class="lineno"> 4</span>             <span class="n">tensor_in</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">fully_connected</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="n">activation_fn</span><span class="p">)</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>     <span class="n">tensor_out</span> <span class="o">=</span> <span class="n">tensor_in</span>
<span class="lineno"> 7</span>     <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
<span class="lineno"> 8</span>         <span class="n">tensor_out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">fully_connected</span><span class="p">(</span><span class="n">tensor_out</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span>
<span class="lineno"> 9</span>                                                        <span class="n">activation_fn</span><span class="o">=</span><span class="n">activation_fn</span><span class="p">)</span>
<span class="lineno">10</span>         <span class="n">tensor_out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">tensor_out</span><span class="p">,</span> <span class="n">keep_prob</span><span class="o">=</span><span class="n">keep_prob</span><span class="p">)</span>
<span class="lineno">11</span> 
<span class="lineno">12</span>     <span class="k">return</span> <span class="n">tensor_out</span></code></pre></div>

<p>Using the layers defined earlier we can easily define LeNet model:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="k">def</span> <span class="nf">flatten_convolution</span><span class="p">(</span><span class="n">tensor_in</span><span class="p">):</span>
<span class="lineno"> 2</span>     <span class="n">tendor_in_shape</span> <span class="o">=</span> <span class="n">tensor_in</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()</span>
<span class="lineno"> 3</span>     <span class="n">tensor_in_flat</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tensor_in</span><span class="p">,</span> <span class="p">[</span><span class="n">tendor_in_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">tendor_in_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
<span class="lineno"> 4</span>     <span class="k">return</span> <span class="n">tensor_in_flat</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>     <span class="k">def</span> <span class="nf">lenet_model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">image_size</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">IMAGE_SIZE</span><span class="p">,</span> <span class="n">IMAGE_SIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
<span class="lineno"> 7</span>         <span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="lineno"> 8</span>         <span class="n">X</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">image_size</span><span class="p">)</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>         <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s">&#39;layer1&#39;</span><span class="p">):</span>
<span class="lineno">11</span>             <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno">12</span> <span class="sd">            Valid:</span>
<span class="lineno">13</span> <span class="sd">             * input: (?, 28, 28, 1)</span>
<span class="lineno">14</span> <span class="sd">             * filter: (5, 5, 1, 4)</span>
<span class="lineno">15</span> <span class="sd">             * pool: (1, 2, 2, 1)</span>
<span class="lineno">16</span> <span class="sd">             * output: (?, 12, 12, 4)</span>
<span class="lineno">17</span> <span class="sd">            Same:</span>
<span class="lineno">18</span> <span class="sd">             * input: (?, 28, 28, 1)</span>
<span class="lineno">19</span> <span class="sd">             * filter: (5, 5, 1, 4)</span>
<span class="lineno">20</span> <span class="sd">             * pool: (1, 2, 2, 1)</span>
<span class="lineno">21</span> <span class="sd">             * output: (?, 14, 14, 4)</span>
<span class="lineno">22</span> <span class="sd">            &quot;&quot;&quot;</span>
<span class="lineno">23</span>             <span class="n">layer1</span> <span class="o">=</span> <span class="n">lenet_layer</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">pool_size</span><span class="p">)</span>
<span class="lineno">24</span> 
<span class="lineno">25</span>         <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s">&#39;layer2&#39;</span><span class="p">):</span>
<span class="lineno">26</span>             <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno">27</span> <span class="sd">            VALID:</span>
<span class="lineno">28</span> <span class="sd">             * input: (?, 12, 12, 4)</span>
<span class="lineno">29</span> <span class="sd">             * filter: (5, 5, 4, 6)</span>
<span class="lineno">30</span> <span class="sd">             * pool: (1, 2, 2, 1)</span>
<span class="lineno">31</span> <span class="sd">             * output: (?, 4, 4, 6)</span>
<span class="lineno">32</span> <span class="sd">             * flat_output: (?, 4 * 4 * 6)</span>
<span class="lineno">33</span> <span class="sd">            SAME:</span>
<span class="lineno">34</span> <span class="sd">             * input: (?, 14, 14, 4)</span>
<span class="lineno">35</span> <span class="sd">             * filter: (5, 5, 4, 6)</span>
<span class="lineno">36</span> <span class="sd">             * pool: (1, 2, 2, 1)</span>
<span class="lineno">37</span> <span class="sd">             * output: (?, 7, 7, 6)</span>
<span class="lineno">38</span> <span class="sd">             * flat_output: (?, 7 * 7 * 6)</span>
<span class="lineno">39</span> <span class="sd">            &quot;&quot;&quot;</span>
<span class="lineno">40</span>             <span class="n">layer2</span> <span class="o">=</span> <span class="n">lenet_layer</span><span class="p">(</span><span class="n">layer1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">pool_size</span><span class="p">)</span>
<span class="lineno">41</span>             <span class="n">layer2_flat</span> <span class="o">=</span> <span class="n">flatten_convolution</span><span class="p">(</span><span class="n">layer2</span><span class="p">)</span>
<span class="lineno">42</span> 
<span class="lineno">43</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">dense_layer</span><span class="p">(</span><span class="n">layer2_flat</span><span class="p">,</span> <span class="p">[</span><span class="mi">1024</span><span class="p">],</span> <span class="n">activation_fn</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">tanh</span><span class="p">,</span> <span class="n">keep_prob</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="lineno">44</span>         <span class="n">prediction</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">logistic_regression_zero_init</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="lineno">45</span>         <span class="n">train_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">optimize_loss</span><span class="p">(</span>
<span class="lineno">46</span>             <span class="n">loss</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">get_global_step</span><span class="p">(),</span> <span class="n">optimizer</span><span class="o">=</span><span class="s">&#39;Adagrad&#39;</span><span class="p">,</span>
<span class="lineno">47</span>             <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="lineno">48</span>         <span class="k">return</span> <span class="p">{</span><span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&#39;prob&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">},</span> <span class="n">loss</span><span class="p">,</span> <span class="n">train_op</span></code></pre></div>

<p>Finally after running our model, we can look at the loss and the model graph</p>

<p><img src="/images/posts/lenet_model.png" alt="LeNet model graph" />
<img src="/images/posts/lenet_loss.png" alt="model loss" />
<img src="/images/posts/lenet_loss_mean.png" alt="model loss mean" /></p>

<p>Here’s also AlexNet’s model graph</p>

<p><img src="/images/posts/alexnet_model.png" alt="AlexNet model graph" /></p>

<p>The full code used in this tutorial can be found in this github <a href="https://github.com/mouradmourafiq/tensorflow-convolution-models">repo</a></p>

            
<div class="social">
  
  <div class='twitter'>
    <a href="https://twitter.com/share" class="twitter-share-button"  data-text="Playing with convolutions in TensorFlow" data-related="mmourafiq">Tweet</a>
  </div>
  

  
  <div class='facebook'>
    <div class="fb-share-button" data-layout="button_count"></div>
  </div>
  

  
  <div class='google'>
    <div class="g-plusone" data-size="medium"></div>
  </div>
  
    
  
  <div class='hn'>
    <a href="https://news.ycombinator.com/submit" class="hn-button" data-title="Playing with convolutions in TensorFlow" data-url="http://mourafiq.com/2016/08/10/playing-with-convolutions-in-tensorflow.html" data-count="horizontal">Vote on Hacker News</a>
  </div>
  

  
  <div class='reddit'>
    <a href="//www.reddit.com/submit" onclick="window.open('//www.reddit.com/submit?url=http://mourafiq.com/2016/08/10/playing-with-convolutions-in-tensorflow.html&title=Playing+with+convolutions+in+TensorFlow'); return false"> <img src="//www.redditstatic.com/spreddit7.gif" alt="submit to reddit" border="0" /> </a>
  </div>
  
</div>

        </section>

        <footer>
            <address>
                <img src="/images/logo.png">
                <p>
                Written by <strong><a rel="author" href="https://twitter.com/mmourafiq" title="Mourad Mourafiq." target="_blank">Mourad Mourafiq.</a></strong><br>
                    <span class="muted">Maths, Technology, Philosophy, Startups, ...</span>
                </p>
            </address>
             
            
            
            <section class="post_summary">
                <h3 class="title">Previous story: <a href="/2016/05/15/predicting-sequences-using-rnn-in-tensorflow.html" rel="prefetch">Sequence prediction using recurrent neural networks(LSTM) with TensorFlow</a></h3>
                <p>LSTM regression using TensorFlow.</p>
                <hr>
            </section>
             
            
            <section>
                <div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'mourafiq';

  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
            </section>
            
        </footer>
    </div>
</article>


    <footer class="site-footer">
        <div class="container">
            &copy; 2016 Mourad Mourafiq

            <nav>
                <a href="/">Blog</a> &middot;
                <a href="/about.html">About</a>
            </nav>

            <nav class="social">
                
<a href="https://twitter.com/mmourafiq" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter"></i></a>


<a href="https://github.com/mouradmourafiq" title="Watch on Github" target="_blank"><i class="icon icon-github"></i></a>


<a href="/atom.xml" title="RSS Feed">
  <i class="icon icon-rss"></i>
</a>

            </nav>
            <div>Based on Incorporated theme by <a href="https://sendtoinc.com">Inc</a></div>
        </div>
    </footer>

</body>
</html>
